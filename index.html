<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saisie de Tourn√©e - Version Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #eaeff2; color: #333; }
        
        /* En-t√™te */
        .header-box { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-box h1 { margin-top: 0; color: #2c3e50; font-size: 1.8em; }

        .main-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .left-panel { flex: 1; min-width: 380px; }
        .right-panel { flex: 1.5; min-width: 380px; }
        
        /* Champs */
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px; border: 1px solid #dcdcdc; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: border 0.3s; }
        input:focus { border-color: #3498db; outline: none; }
        label { font-weight: 700; color: #576574; font-size: 0.85em; display: block; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .row-inputs { display: flex; gap: 15px; }
        .row-inputs > div { flex: 1; }

        /* Zone d'ajout */
        .add-stop-box { background: white; padding: 25px; border-radius: 12px; border-top: 5px solid #1abc9c; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .add-stop-box h3 { margin-top: 0; color: #16a085; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* Recherche & GPS */
        .search-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-search { background: #8e44ad; color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-gps { background: #e67e22; color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; font-size: 1.2em; }
        
        /* Liste & Totaux */
        #stops-list { list-style: none; padding: 0; margin-top: 0; }
        .stop-item { background: white; padding: 15px; margin-bottom: 10px; border-left: 5px solid #3498db; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 6px; animation: slideIn 0.3s ease-out; }
        .stop-info { flex-grow: 1; }
        .btn-delete { background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin-left: 10px; font-weight: bold; }
        
        .totals-box { background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: space-around; font-weight: bold; font-size: 1.1em; }

        /* Carte */
        #map { height: 700px; width: 100%; border-radius: 12px; border: 1px solid #ccc; z-index: 1; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Boutons Actions */
        .btn-add { background: #2980b9; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1.1em; transition: background 0.2s; }
        .btn-add:hover { background: #2471a3; transform: translateY(-1px); }
        
        .btn-save { background: #27ae60; color: white; border: none; padding: 18px; font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; transition: all 0.2s; }
        .btn-save:hover { background: #219150; transform: scale(1.01); }
        .btn-save:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header-box">
        <h1>üì¶ Gestion de Tourn√©e</h1>
        <div class="row-inputs">
            <div>
                <label>üë§ Nom du Producteur</label>
                <input type="text" id="prodName" placeholder="Ex: Ferme du Val">
            </div>
            <div>
                <label>üìÖ Jour</label>
                <select id="prodDay">
                    <option value="Lundi">Lundi</option>
                    <option value="Mardi">Mardi</option>
                    <option value="Mercredi">Mercredi</option>
                    <option value="Jeudi">Jeudi</option>
                    <option value="Vendredi">Vendredi</option>
                </select>
            </div>
            <div>
                <label>‚è±Ô∏è Chargement (min)</label>
                <input type="number" id="loadTime" placeholder="30" min="0">
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            
            <div class="add-stop-box">
                <h3>‚ûï Nouvel Arr√™t</h3>
                
                <label>üìç Localisation</label>
                <div class="search-container">
                    <input type="text" id="addressSearch" placeholder="Adresse ou ville..." onkeypress="handleEnter(event)" style="margin-bottom:0;">
                    <button class="btn-search" onclick="searchAddress()" title="Chercher l'adresse">üîç</button>
                    <button class="btn-gps" onclick="geolocate()" title="Ma position actuelle">üéØ</button>
                </div>
                <div id="latlon-preview" style="color: #16a085; font-size: 0.85em; margin-bottom: 15px; text-align: right; min-height: 1.2em;"></div>

                <label>üè¢ Client / Lieu</label>
                <input type="text" id="stopClient" placeholder="Ex: Le Gourmet">
                
                <div class="row-inputs">
                    <div>
                        <label>‚öñÔ∏è Poids (kg)</label>
                        <input type="number" id="stopWeight" placeholder="0">
                    </div>
                    <div>
                        <label>üí∂ Montant (‚Ç¨)</label>
                        <input type="number" id="stopEuro" placeholder="0">
                    </div>
                </div>

                <label>‚è±Ô∏è Temps d'arr√™t (min)</label>
                <input type="number" id="stopTime" placeholder="15">
                
                <button class="btn-add" onclick="addStop()">Valider et Ajouter</button>
                <p id="error-msg" style="color:red; font-size:0.9em; display:none; text-align:center;">‚ö†Ô∏è Remplissez le nom, le poids et placez un point !</p>
            </div>

            <ul id="stops-list"></ul>

            <div class="totals-box">
                <span id="total-kg">‚öñÔ∏è 0 kg</span>
                <span id="total-eur">üí∂ 0 ‚Ç¨</span>
            </div>

            <button class="btn-save" id="finalBtn" onclick="sendTournee()" disabled>üöÄ ENVOYER LA TOURN√âE</button>
            <div id="status-msg" style="text-align: center; margin-top: 15px; font-weight: bold;"></div>
        </div>

        <div class="right-panel">
            <div id="map"></div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://update-github-csv-149052175314.europe-west1.run.app/"; 

    // Variables globales
    let tourneeStops = [];
    let tempMarker = null;
    let mapMarkers = [];
    let polyline = null;
    let currentAddressTxt = "Saisie Carte";

    // 1. Initialisation Carte
    var map = L.map('map').setView([46.603354, 1.888334], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    // 2. Gestion Recherche & GPS
    function handleEnter(e) { if (e.key === 'Enter') searchAddress(); }

    function searchAddress() {
        let query = document.getElementById('addressSearch').value;
        if(query.length < 3) return;
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if(data && data.length > 0) {
                updateTempMarker(data[0].lat, data[0].lon, query);
                map.setView([data[0].lat, data[0].lon], 16); 
            } else { alert("Adresse introuvable."); }
        });
    }

    function geolocate() {
        if (!navigator.geolocation) { alert("GPS non support√©"); return; }
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                updateTempMarker(pos.coords.latitude, pos.coords.longitude, "Ma Position GPS");
                map.setView([pos.coords.latitude, pos.coords.longitude], 16);
            },
            () => alert("Impossible de r√©cup√©rer votre position.")
        );
    }

    map.on('click', function(e) {
        updateTempMarker(e.latlng.lat, e.latlng.lng, "Point√© sur la carte");
    });

    function updateTempMarker(lat, lon, addressLabel) {
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker([lat, lon], {opacity: 0.7}).addTo(map);
        currentAddressTxt = addressLabel;
        
        let el = document.getElementById('latlon-preview');
        el.dataset.lat = lat; el.dataset.lon = lon;
        el.innerHTML = `üìç ${parseFloat(lat).toFixed(4)}, ${parseFloat(lon).toFixed(4)} <br> <i>(${addressLabel})</i>`;
        document.getElementById('error-msg').style.display = 'none';
    }

    // 3. Ajouter / Supprimer / Afficher
    function addStop() {
        // R√©cup√©ration
        let client = document.getElementById('stopClient').value;
        let poids = document.getElementById('stopWeight').value;
        let montant = document.getElementById('stopEuro').value;
        let temps = document.getElementById('stopTime').value;
        let lat = document.getElementById('latlon-preview').dataset.lat;
        let lon = document.getElementById('latlon-preview').dataset.lon;

        if (!client || !poids || !lat) {
            document.getElementById('error-msg').style.display = 'block'; return;
        }

        // Ajout Array
        tourneeStops.push({
            client: client,
            poids: parseFloat(poids) || 0,
            montant: parseFloat(montant) || 0,
            temps_arret: parseFloat(temps) || 0,
            adresse_txt: currentAddressTxt,
            lat: lat, lon: lon
        });

        // Reset Champs
        document.getElementById('stopClient').value = '';
        document.getElementById('stopWeight').value = '';
        document.getElementById('stopEuro').value = '';
        document.getElementById('stopTime').value = '';
        document.getElementById('addressSearch').value = '';
        document.getElementById('latlon-preview').innerHTML = '';
        delete document.getElementById('latlon-preview').dataset.lat;
        if (tempMarker) map.removeLayer(tempMarker);

        refreshUI();
    }

    function removeStop(index) {
        if(confirm("Supprimer cet arr√™t ?")) {
            tourneeStops.splice(index, 1);
            refreshUI();
        }
    }

    // Fonction centrale qui redessine tout (Liste + Carte + Totaux)
    function refreshUI() {
        const list = document.getElementById('stops-list');
        list.innerHTML = "";
        
        // Nettoyage carte
        mapMarkers.forEach(m => map.removeLayer(m));
        mapMarkers = [];
        if (polyline) map.removeLayer(polyline);

        let totalKg = 0;
        let totalEur = 0;

        tourneeStops.forEach((stop, index) => {
            // Totaux
            totalKg += stop.poids;
            totalEur += stop.montant;

            // HTML Liste
            let li = document.createElement('li');
            li.className = 'stop-item';
            li.innerHTML = `
                <div class="stop-number" style="background:#3498db; color:white; width:25px; height:25px; border-radius:50%; text-align:center; line-height:25px; margin-right:10px; font-weight:bold;">${index + 1}</div>
                <div class="stop-info">
                    <strong>${stop.client}</strong>
                    <div style="font-size:0.85em; color:#7f8c8d;">${stop.poids}kg | ${stop.montant}‚Ç¨ | ${stop.adresse_txt}</div>
                </div>
                <button class="btn-delete" onclick="removeStop(${index})">‚úï</button>
            `;
            list.appendChild(li);

            // Marqueurs Carte
            let m = L.marker([stop.lat, stop.lon]).addTo(map).bindPopup(`<b>${index+1}. ${stop.client}</b>`);
            mapMarkers.push(m);
        });

        // Ligne
        if (tourneeStops.length > 1) {
            let latlngs = tourneeStops.map(s => [s.lat, s.lon]);
            polyline = L.polyline(latlngs, {color: '#2c3e50', weight: 4}).addTo(map);
            map.fitBounds(polyline.getBounds().pad(0.1));
        }

        // Update Totaux & Bouton
        document.getElementById('total-kg').innerText = `‚öñÔ∏è ${totalKg} kg`;
        document.getElementById('total-eur').innerText = `üí∂ ${totalEur} ‚Ç¨`;
        
        let btn = document.getElementById('finalBtn');
        btn.innerText = `üöÄ ENVOYER (${tourneeStops.length} arr√™ts)`;
        btn.disabled = tourneeStops.length === 0;
    }

    // 4. Envoi
    function sendTournee() {
        let prod = document.getElementById('prodName').value;
        if (!prod) { alert("Nom du producteur manquant !"); return; }
        
        let btn = document.getElementById('finalBtn');
        let status = document.getElementById('status-msg');
        btn.disabled = true;
        status.innerText = "‚è≥ Envoi en cours...";

        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                general: { 
                    Producteur: prod, 
                    Jour: document.getElementById('prodDay').value,
                    TempsChargement: document.getElementById('loadTime').value || 0 
                },
                stops: tourneeStops
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                status.innerText = "‚úÖ Tourn√©e enregistr√©e !";
                status.style.color = "green";
                setTimeout(() => location.reload(), 2000);
            } else { throw new Error(data.error); }
        })
        .catch(err => {
            status.innerText = "‚ùå " + err.message;
            status.style.color = "red";
            btn.disabled = false;
        });
    }
</script>

</body>
</html>
