<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Logistique V19</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --bg: #eaeff2; --danger: #e74c3c; --info: #2980b9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: var(--bg); color: #333; font-size: 13px; }
        
        /* BANDEAU HAUT */
        .header-band { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-top: 6px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header-band.saved { border-top-color: var(--success); }

        /* LAYOUT */
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .left-panel { flex: 1; min-width: 400px; }
        .right-panel { flex: 1.5; min-width: 400px; }

        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stop-box { border-left: 6px solid #1abc9c; }
        .active-zone { background: #fffbf0 !important; border-color: var(--accent) !important; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .form-group label { display: block; font-weight: bold; color: #7f8c8d; margin-bottom: 5px; font-size: 0.8rem; }
        input, select { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; }
        
        .search-bar { display: flex; gap: 5px; }
        .btn-mini { padding: 8px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-target { background: #95a5a6; min-width: 70px; }
        .btn-target.active { background: var(--accent); }

        #stops-list { list-style: none; padding: 0; margin: 10px 0; }
        .stop-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; border-left: 5px solid #3498db; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* RÃ‰SULTATS */
        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .res-item { background: var(--primary); color: white; padding: 12px; border-radius: 8px; text-align: center; }
        .res-item b { display: block; font-size: 1.1rem; margin-top: 4px; }
        
        .cost-card { padding: 15px; border-radius: 8px; color: white; text-align: center; flex: 1; }
        .cost-transport { background: var(--info); }
        .cost-human { background: #8e44ad; }
        .cost-final { background: var(--danger); }

        .ratio-box { grid-column: span 3; background: var(--accent); color: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-around; align-items: center; }

        #map { height: 450px; width: 100%; border-radius: 12px; border: 1px solid #ccc; background: #ddd; }
        .btn-main { background: var(--success); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
    </style>
</head>
<body>

    <button onclick="localStorage.clear(); location.reload();" class="btn-mini" style="float:right; background:var(--danger)">ğŸ§¹ Reset Complet</button>
    <h2 style="color: var(--primary); margin-bottom: 15px;">ğŸš› Simulateur Logistique Expert V19</h2>

    <div class="header-band" id="box-prod" onclick="setMode('prod')">
        <div class="grid">
            <div class="form-group" style="grid-column: span 2;">
                <label>Nom Producteur / Ferme</label>
                <input type="text" id="pName" placeholder="Ex: Ferme du Val" onchange="saveProd()">
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>ğŸ“ Adresse de DÃ©part (DÃ©pÃ´t)</label>
                <div class="search-bar">
                    <input type="text" id="pAddr" placeholder="Tapez une adresse OU cliquez sur ğŸ¯">
                    <button class="btn-mini" style="background:var(--info)" onclick="searchAddress('prod')">ğŸ”</button>
                    <button class="btn-mini btn-target" id="btn-t-prod" onclick="setMode('prod'); event.stopPropagation();">ğŸ¯ CIBLE</button>
                </div>


            </div>
            <div class="form-group"><label>ğŸ“¦ PrÃ©p. (min)</label><input type="number" id="tPrep" value="30" onchange="updateStats()"></div>
            <div class="form-group"><label>ğŸšš Charg. (min)</label><input type="number" id="tLoad" value="20" onchange="updateStats()"></div>
            <div class="form-group"><label>ğŸ’¶ Main d'Oeuvre (â‚¬/h)</label><input type="number" id="cH" value="15" onchange="updateStats()"></div>
            <div class="form-group"><label>â›½ Carburant (â‚¬/km)</label><input type="number" id="cK" value="0.5" step="0.1" onchange="updateStats()"></div>
            <div class="form-group">
                <label>Type VÃ©hicule</label>
                <select id="vType">
                    <option>Petit (<3mÂ³)</option><option>Moyen (3-6mÂ³)</option><option>Grand (6-12mÂ³)</option><option>Poids Lourd</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ã‰nergie</label>
                <select id="fType">
                    <option>Diesel</option><option>Essence</option><option>Ã‰lectrique</option><option>GNV / Bio-mÃ©thane</option>
                </select>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="card stop-box" id="box-stop" onclick="setMode('stop')">
                <h3 style="margin:0 0 15px 0;">â• Ajouter un ArrÃªt</h3>
                <div class="form-group">
                    <label>Localisation</label>
                    <div class="search-bar">
                        <input type="text" id="sAddr" placeholder="Tapez une adresse OU cliquez sur ğŸ¯">
                        <button class="btn-mini" style="background:var(--info)" onclick="searchAddress('stop')">ğŸ”</button>
                        <button class="btn-mini btn-target" id="btn-t-stop" onclick="setMode('stop'); event.stopPropagation();">ğŸ¯ CIBLE</button>
                    </div>
                </div>
                <div class="grid" style="margin-top:10px;">
                    <div class="form-group" style="grid-column: span 2;"><label>Nom Client / Lieu</label><input type="text" id="sClient"></div>
                    <div class="form-group"><label>Valeur (â‚¬)</label><input type="number" id="sEuro" value="0"></div>
                    <div class="form-group"><label>â±ï¸ ArrÃªt (min)</label><input type="number" id="sTime" value="15"></div>
                </div>
                <button class="btn-main" style="background:var(--info); margin-top:15px;" onclick="addStop()">Ajouter Ã  la tournÃ©e</button>
            </div>
            <ul id="stops-list"></ul>
            <button class="btn-main" id="btnSend" onclick="sendData()" disabled>ğŸš€ ENREGISTRER LA TOURNÃ‰E</button>
        </div>

        <div class="right-panel">
            <div id="map" class="card" style="padding:0;"></div>
            <div class="res-grid">
                <div class="res-item"><span>ğŸ›£ï¸ Distance</span><b id="rDist">0 km</b></div>
                <div class="res-item"><span>Temps Conduite</span><b id="rTime">0h00</b></div>
                <div class="res-item"><span>Temps Service</span><b id="rOps">0h00</b></div>
                
                <div style="grid-column: span 3; display: flex; gap: 10px;">
                    <div class="cost-card cost-transport"><span>ğŸš› Transport</span><small>(Carb. + Chauffeur)</small><b id="rCostTrans">0 â‚¬</b></div>
                    <div class="cost-card cost-human"><span>ğŸ¤ Manutention</span><small>(PrÃ©p. + ArrÃªts)</small><b id="rCostOps">0 â‚¬</b></div>
                    <div class="cost-card cost-final"><span>ğŸ’° TOTAL GLOBAL</span><b id="rTotal">0 â‚¬</b></div>
                </div>
                
                <div class="ratio-box">
                    <div><span>ğŸ“¦ Valeur Marchandise</span><b id="rVal" style="font-size:1.5rem;">0 â‚¬</b></div>
                    <div style="width:1px; height:40px; background:rgba(255,255,255,0.3);"></div>
                    <div><span>ğŸ“‰ Ratio Logistique</span><b id="rRatio" style="font-size:1.5rem;">0 %</b></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://update-github-csv-149052175314.europe-west1.run.app/";
        let map, markers, routeLayer;
        let stops = [];
        let mode = 'stop';
        let pData = { lat:null, lon:null, addr: "" };
        let sTemp = { lat:null, lon:null };

        document.addEventListener('DOMContentLoaded', function() {
            try {
                map = L.map('map').setView([46.6, 1.88], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                markers = L.layerGroup().addTo(map);
                routeLayer = L.layerGroup().addTo(map);
                map.on('click', onMapClick);
                
                let saved = localStorage.getItem('pMem_v19');
                if(saved) {
                    pData = JSON.parse(saved);
                    document.getElementById('pName').value = pData.name || "";
                    document.getElementById('pAddr').value = pData.addr || "";
                    updateView();
                }
                setMode('stop');
            } catch (e) { console.error("Erreur Init :", e); }
        });

        function setMode(m) {
            mode = m;
            document.getElementById('btn-t-prod').classList.toggle('active', m==='prod');
            document.getElementById('btn-t-stop').classList.toggle('active', m==='stop');
            document.getElementById('box-prod').classList.toggle('active-zone', m==='prod');
            document.getElementById('box-stop').classList.toggle('active-zone', m==='stop');
        }

        function onMapClick(e) {
            let lat = e.latlng.lat;
            let lon = e.latlng.lng;
            markers.clearLayers();
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'ğŸ ', className:''})}).addTo(markers);
            stops.forEach(s => L.circleMarker([s.lat, s.lon], {radius:8, color:'blue', fillOpacity:1}).addTo(markers));
            L.circleMarker([lat, lon], {radius:10, color:'orange', weight:3, fillOpacity:0.5}).addTo(markers);

            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json()).then(d => {
                    let a = d.display_name || "Lieu sÃ©lectionnÃ©";
                    if(mode === 'prod') {
                        pData = { lat, lon, addr: a, name: document.getElementById('pName').value };
                        document.getElementById('pAddr').value = a;
                        saveProd();
                    } else {
                        sTemp = { lat, lon };
                        document.getElementById('sAddr').value = a;
                    }
                });
        }

        function saveProd() {
            pData.name = document.getElementById('pName').value;
            localStorage.setItem('pMem_v19', JSON.stringify(pData));
            updateView();
        }

        function addStop() {
            if(!pData.lat) return alert("DÃ©finissez le Producteur !");
            if(!sTemp.lat) return alert("Cliquez sur la carte !");
            stops.push({
                client: document.getElementById('sClient').value || "Client",
                euro: parseFloat(document.getElementById('sEuro').value) || 0,
                time: parseFloat(document.getElementById('sTime').value) || 15,
                lat: sTemp.lat, lon: sTemp.lon
            });
            sTemp = { lat:null, lon:null };
            document.getElementById('sAddr').value = "";
            document.getElementById('sClient').value = "";
            updateView();
        }

        function updateView() {
            markers.clearLayers();
            routeLayer.clearLayers();
            let ul = document.getElementById('stops-list');
            ul.innerHTML = "";
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'ğŸ ', className:''})}).addTo(markers);
            stops.forEach((s, i) => {
                ul.innerHTML += `<li class="stop-item"><span><b>${i+1}.</b> ${s.client}</span><button onclick="stops.splice(${i},1); updateView()" style="background:none; border:none; color:red; cursor:pointer;">âœ•</button></li>`;
                L.circleMarker([s.lat, s.lon], {radius:8, color:'blue', fillOpacity:1}).addTo(markers);
            });
            if(pData.lat && stops.length > 0) calcRoute();
            document.getElementById('btnSend').disabled = stops.length === 0;
        }

        function calcRoute() {
            let pts = [[pData.lon, pData.lat], ...stops.map(s => [s.lon, s.lat]), [pData.lon, pData.lat]];
            fetch(`https://router.project-osrm.org/route/v1/driving/${pts.map(p => p.join(',')).join(';')}?overview=full&geometries=geojson`)
                .then(r => r.json()).then(res => {
                    if(res.code === 'Ok') {
                        let rData = res.routes[0];
                        L.polyline(rData.geometry.coordinates.map(c => [c[1], c[0]]), {color:'blue', weight:4}).addTo(routeLayer);
                        map.fitBounds(L.featureGroup(markers.getLayers()).getBounds().pad(0.1));
                        updateStats(rData.distance/1000, rData.duration/60);
                    }
                });
        }

        function updateStats(dist = 0, driveTime = 0) {
            let prep = parseFloat(document.getElementById('tPrep').value) || 0;
            let load = parseFloat(document.getElementById('tLoad').value) || 0;
            let sTime = stops.reduce((a, b) => a + b.time, 0);
            let totalOps = prep + load + sTime;
            let cH = parseFloat(document.getElementById('cH').value) || 15;
            let cK = parseFloat(document.getElementById('cK').value) || 0.5;

            let cTrans = (dist * cK) + ((driveTime / 60) * cH);
            let cOps = (totalOps / 60) * cH;
            let total = cTrans + cOps;
            let val = stops.reduce((a, b) => a + b.euro, 0);

            document.getElementById('rDist').innerText = dist.toFixed(1) + " km";
            document.getElementById('rTime').innerText = Math.floor(driveTime/60) + "h" + Math.round(driveTime%60).toString().padStart(2,'0');
            document.getElementById('rOps').innerText = Math.floor(totalOps/60) + "h" + Math.round(totalOps%60).toString().padStart(2,'0');
            document.getElementById('rCostTrans').innerText = cTrans.toFixed(1) + " â‚¬";
            document.getElementById('rCostOps').innerText = cOps.toFixed(1) + " â‚¬";
            document.getElementById('rTotal').innerText = total.toFixed(0) + " â‚¬";
            document.getElementById('rVal').innerText = val + " â‚¬";
            document.getElementById('rRatio').innerText = val > 0 ? (total/val*100).toFixed(1) + " %" : "0 %";
        }

        function sendData() {
            let btn = document.getElementById('btnSend');
            btn.disabled = true;
            btn.innerText = "Envoi...";

            let payload = {
                general: { 
                    Producteur: document.getElementById('pName').value, 
                    AdresseProd: pData.addr,
                    LatProd: pData.lat,
                    LonProd: pData.lon,
                    CoutHoraire: parseFloat(document.getElementById('cH').value),
                    CoutKm: parseFloat(document.getElementById('cK').value),
                    TempsPreparation: parseFloat(document.getElementById('tPrep').value),
                    TempsChargement: parseFloat(document.getElementById('tLoad').value),
                    Vehicule: document.getElementById('vType').value,
                    Carburant: document.getElementById('fType').value,
                    DistanceTotale: document.getElementById('rDist').innerText,
                    CoutTransport: document.getElementById('rCostTrans').innerText,
                    CoutManutention: document.getElementById('rCostOps').innerText,
                    CoutTotal: document.getElementById('rTotal').innerText,
                    ValeurMarchandise: document.getElementById('rVal').innerText
                },
                stops: stops
            };

            fetch(API, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(payload) 
            })
            .then(response => {
                if (!response.ok) throw new Error('Erreur serveur');
                return response.json();
            })
            .then(data => {
                alert("âœ… TournÃ©e enregistrÃ©e avec succÃ¨s !");
                stops = [];
                updateView();
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert("âŒ Erreur lors de l'enregistrement. VÃ©rifiez votre connexion.");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "ğŸš€ ENREGISTRER LA TOURNÃ‰E";
            });
        }
    </script>
</body>
</html>
