<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Logistique - PNR Pr√©alpes</title>
    <link rel="icon" href="https://github.com/pierrealainmory-hue/logistique-data-projet/blob/main/LogoEpurvertpetit.png?raw=true">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --bg: #f4f7f9; --danger: #e74c3c; --info: #3498db; --lib: #8e44ad; --text: #546e7a; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        
        .client-header { background: white; padding: 15px 25px; border-radius: 6px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 6px solid var(--success); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .client-logo { height: 85px; width: auto; }
        .header-band { background: white; padding: 20px; border-radius: 6px; margin-bottom: 20px; border-top: 6px solid var(--primary); transition: all 0.3s; }
        .header-band.validated { border-top-color: var(--success); background-color: #f6fffa; }
        
        .main-container { display: flex; gap: 25px; flex: 1; margin-bottom: 30px;}
        .left-panel { flex: 1; min-width: 380px; }
        .right-panel { flex: 2; min-width: 300px; display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eef2f7; }
        
        .form-group { flex: 1; display: flex; flex-direction: column; gap: 5px; min-width: 100px; }
        input, select { padding: 10px; border: 1px solid #dcdfe6; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        .tour-row { padding: 15px; border-bottom: 1px solid #eee; background: #fff; display: grid; grid-template-columns: 2fr 4fr 3fr 100px; align-items: center; cursor: pointer; }
        .tour-row:hover { background: #f9f9f9; }
        .tour-row.active { background: #f4ecf7; border-left: 4px solid var(--lib); }
        
        #map { height: 450px; width: 100%; border-radius: 6px; }
        .btn-main { background: var(--success); color: white; width: 100%; padding: 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-mini { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        
        /* KPI & GLOBAL */
        .summary-banner { background: var(--primary); color: white; border-radius: 6px; padding: 15px; text-align: center; }
        .banner-metrics { display: flex; justify-content: space-around; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); }
        .kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .kpi-card { background: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #eee; }
        
        .global-stats-box { background: #f8f9fa; color: var(--primary); border: 1px solid #dcdfe6; border-radius: 6px; padding: 15px; margin: 15px 0; display: flex; justify-content: space-around; font-weight: bold; }
        .legend-bar { background: white; padding: 8px; border-radius: 6px; display: flex; justify-content: center; gap: 15px; font-size: 0.8rem; }
        .legend-tag-title { background: #eee; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        .stop-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .ratio-good { background: #d5f5e3; color: #27ae60; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; }
        .ratio-mid { background: #fdebd0; color: #e67e22; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; }
        .ratio-bad { background: #fadbd8; color: #e74c3c; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div class="client-header">
        <div style="display:flex; align-items:center; gap:20px;">
            <img src="https://www.parcs-naturels-regionaux.fr/sites/federationpnr/files/styles/contenu/public/image/parc/sans_titre.png?itok=z_7I7Msh" alt="Logo" class="client-logo">
            <div>
                <h1 style="margin:0; color:var(--success);">PNR Pr√©alpes d'Azur</h1>
                <span>Logistique Circuit Court</span>
            </div>
        </div>
        <div class="assistance-box">
            <b>Assistance</b><br>Pierre-Alain Mory<br>07 83 00 09 56
        </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; color:#7f8c8d;">Configuration</h2>
        <button onclick="localStorage.clear(); location.reload();" class="btn-mini" style="background:var(--danger);">R√©initialiser</button>
    </div>

    <div class="header-band" id="prod-band">
        <div id="header-form">
            <div class="header-row">
                <div class="form-group" style="flex:1.5;"><label>Nom Ferme/Producteur</label><input type="text" id="pName" placeholder="Ex: Ferme du Soleil"></div>
                <div class="form-group" style="flex:2;"><label>üìç Adresse D√©p√¥t</label><div style="display:flex; gap:5px;"><input type="text" id="pAddr"><button class="btn-mini" style="background:var(--info);" onclick="searchAddress('prod')">üîç</button></div></div>
            </div>
            <div class="header-row" style="background:#f8f9fa; padding:10px; border-radius:4px;">
                <div class="form-group"><label>üöö V√©hicule</label><select id="vType"><option>Petit utilitaire</option><option selected>Fourgon compact</option><option>Grand fourgon</option><option>Camion</option></select></div>
                <div class="form-group"><label>Conso (L/100km)</label><input type="number" id="vCons" value="8.5"></div>
                <div class="form-group"><label>Prix Carb (‚Ç¨/L)</label><input type="number" id="fPrice" value="1.75"></div>
                <div class="form-group"><label>Co√ªt H (‚Ç¨/h)</label><input type="number" id="cH" value="18"></div>
                <div class="form-group"><label>Temps Pr√©p (min)</label><input type="number" id="tPrep" value="30"></div>
                <div class="form-group"><label>Temps Charg (min)</label><input type="number" id="tLoad" value="20"></div>
            </div>
            <button class="btn-main" onclick="lockDepot()">‚úÖ Valider D√©p√¥t</button>
        </div>
        <div id="header-summary" style="display:none; justify-content:space-between; align-items:center;">
            <div id="summary-content" style="font-weight:bold; color:var(--primary);"></div>
            <button class="btn-mini" style="background:var(--info);" onclick="unlockDepot()">Modifier</button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel" id="locked-section" style="opacity:0.5; pointer-events:none;">
            <div class="card" style="border-left:6px solid var(--accent);">
                <div style="display:flex; justify-content:space-between;">
                    <h3 style="margin:0; color:var(--accent);">üìÖ Tourn√©e</h3>
                    <button class="btn-mini" style="background:#95a5a6;" onclick="newTour()">‚ûï Nouvelle</button>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div class="form-group" style="flex:2;"><label>Nom</label><input type="text" id="tName" list="tourSuggestions" oninput="updateStatsTitle()"></div>
                    <datalist id="tourSuggestions"></datalist>
                    <div class="form-group"><label>Jour</label><select id="tDay" onchange="autoNameTour()"><option>Lundi</option><option>Mardi</option><option>Mercredi</option><option>Jeudi</option><option>Vendredi</option><option>Samedi</option></select></div>
                </div>
            </div>

            <div class="card" style="border-left:6px solid var(--success);">
                <h3 style="margin:0;">üìç Ajouter Arr√™t</h3>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div class="form-group" style="flex:1.5;"><label>Client</label><input type="text" id="sClient"></div>
                    <div class="form-group"><label>Op√©ration</label><select id="sOpType"><option value="Livraison">Livraison</option><option value="Collecte">Collecte</option></select></div>
                </div>
                <div class="form-group" style="margin-top:5px;"><label>Adresse</label><div style="display:flex; gap:5px;"><input type="text" id="sAddr"><button class="btn-mini" style="background:var(--info);" onclick="searchAddress('stop')">üîç</button></div></div>
                <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                    <div class="form-group"><label>CA (‚Ç¨)</label><input type="number" id="sEuro" value="0"></div>
                    <div class="form-group"><label>Vol (kg)</label><input type="number" id="sVol" value="0"></div>
                    <div class="form-group"><label>Temps (min)</label><input type="number" id="sTime" value="15"></div>
                </div>
                <button class="btn-main" style="background:var(--info); margin-top:15px;" onclick="addStop()">Ajouter</button>
            </div>

            <h4>üìã Liste des Arr√™ts</h4>
            <ul id="stops-list"></ul>
            
            <div class="legend-bar">
                <span class="legend-tag-title">Ratio</span>
                <span><span class="legend-dot" style="background:#27ae60;"></span> <10%</span>
                <span><span class="legend-dot" style="background:#e67e22;"></span> 10-30%</span>
                <span><span class="legend-dot" style="background:#e74c3c;"></span> >30%</span>
            </div>

            <button class="btn-main" onclick="saveCurrentTour()">üíæ SAUVEGARDER TOURNEE</button>
        </div>

        <div class="right-panel">
            <div id="map"></div>
            
            <div class="kpi-container">
                <div class="summary-banner">
                    <div style="font-weight:bold; font-size:1.1rem;">R√âCAPITULATIF COURANT</div>
                    <div class="banner-metrics">
                        <div><small>CO√õT</small><br><span style="font-size:1.5rem;" id="rTotal">0 ‚Ç¨</span></div>
                        <div><small>CA</small><br><span style="font-size:1.5rem;" id="rVal">0 ‚Ç¨</span></div>
                    </div>
                </div>
                <div class="kpi-card"><div>DISTANCE</div><div class="kpi-value" id="rDist">0 km</div></div>
                <div class="kpi-card"><div>CARBURANT</div><div class="kpi-value" id="rCostTrans">0 ‚Ç¨</div></div>
                <div class="kpi-card"><div>MAIN D'OEUVRE</div><div class="kpi-value" id="rCostOps">0 ‚Ç¨</div></div>
                <div class="kpi-card" style="grid-column:span 3; color:var(--accent);">
                    <div>RATIO LOGISTIQUE</div><div style="font-size:1.8rem; font-weight:bold;" id="rRatio">0 %</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="border-left:6px solid var(--lib); margin-top:20px;">
        <h3 style="margin:0; color:var(--lib);">üìÇ Dossier : Mes Tourn√©es Enregistr√©es</h3>
        
        <div id="global-totals-container" class="global-stats-box" style="display:none;">
            <div>üí∞ CA: <span id="gt-ca">0</span></div>
            <div>üìâ CO√õT: <span id="gt-cost">0</span></div>
            <div>‚öñÔ∏è RATIO: <span id="gt-ratio">0</span></div>
            <div>üõ£Ô∏è KM: <span id="gt-dist">0</span></div>
            <div>‚è±Ô∏è TEMPS: <span id="gt-time">0</span></div>
        </div>

        <div id="tours-list-container"></div>
        
        <div style="text-align:center; margin-top:20px;">
            <button class="btn-main" style="background:var(--lib); width:300px;" onclick="sendProjectData()">üöÄ ENVOYER LE PROJET (CSV)</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://update-github-csv-149052175314.europe-west1.run.app/";
        let map, markers, routeLayer, stops = [], pData = {lat:null, lon:null, addr:""}, sTemp = {lat:null, lon:null};
        let savedTours = [], currentTourId = null;
        let currentStats = {cost:0, ca:0, ratio:0, dist:0, time:0};

        window.onload = function() {
            map = L.map('map').setView([43.76, 6.90], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers = L.layerGroup().addTo(map); routeLayer = L.layerGroup().addTo(map);
            map.on('click', onMapClick);
            Sortable.create(document.getElementById('stops-list'), {animation:150, handle:'.handle', onEnd:reorderStops});
            loadSaved(); autoNameTour(); updateSuggestions();
        };

        function formatMin(m) { return Math.floor(m/60)+"h"+Math.round(m%60).toString().padStart(2,'0'); }
        function updateSuggestions() { 
            const dl = document.getElementById('tourSuggestions'); dl.innerHTML = ''; 
            [...new Set(["Tourn√©e Restos", "Tourn√©e √âcoles", "Tourn√©e Magasins", ...savedTours.map(t=>t.name)])].forEach(n => { let o=document.createElement('option'); o.value=n; dl.appendChild(o); });
        }
        function autoNameTour() { if(!currentTourId && document.getElementById('tName').value==="") { document.getElementById('tName').value = "Tourn√©e - "+document.getElementById('tDay').value+" - "+(savedTours.filter(t=>t.day===document.getElementById('tDay').value).length+1); updateStatsTitle(); } }

        function saveDepot() {
            const d = { pData, veh: { type:document.getElementById('vType').value, cons:document.getElementById('vCons').value, price:document.getElementById('fPrice').value, cH:document.getElementById('cH').value, tPrep:document.getElementById('tPrep').value, tLoad:document.getElementById('tLoad').value } };
            localStorage.setItem('v84_depot', JSON.stringify(d));
        }
        function loadSaved() {
            let s = localStorage.getItem('v84_depot');
            if(s) { const d=JSON.parse(s); pData=d.pData; document.getElementById('pName').value=d.pData.name||""; document.getElementById('pAddr').value=d.pData.addr||""; if(d.veh) { document.getElementById('vType').value=d.veh.type; document.getElementById('vCons').value=d.veh.cons; document.getElementById('fPrice').value=d.veh.price; document.getElementById('cH').value=d.veh.cH; document.getElementById('tPrep').value=d.veh.tPrep; document.getElementById('tLoad').value=d.veh.tLoad; } }
            let t = localStorage.getItem('v84_tours'); savedTours = t ? JSON.parse(t) : []; renderTours();
        }

        function renderTours() {
            const c = document.getElementById('tours-list-container'); c.innerHTML = savedTours.length ? "" : "<div style='text-align:center;color:#999;padding:10px;'>Aucune tourn√©e.</div>";
            let gCA=0, gCost=0, gDist=0, gTime=0;
            savedTours.forEach(t => {
                let div = document.createElement('div'); div.className = 'tour-row ' + (t.id===currentTourId?'active':'');
                let st = t.stats || {ca:0, cost:0, dist:0, time:0};
                gCA+=st.ca; gCost+=st.cost; gDist+=parseFloat(st.dist); gTime+=st.time;
                div.innerHTML = `<div onclick="loadTour('${t.id}')"><div class="t-id"><strong>${t.name}</strong></div><div class="t-day">${t.day}</div></div>
                <div class="t-metrics" onclick="loadTour('${t.id}')"><span>üí∞ ${Math.round(st.ca)}‚Ç¨</span><span>üìâ ${Math.round(st.cost)}‚Ç¨</span><span>üõ£Ô∏è ${st.dist}km</span><span>üõë ${t.stops.length}</span></div>
                <div class="t-actions"><button class="btn-mini" style="background:var(--danger);" onclick="deleteTour('${t.id}')">‚úï</button></div>`;
                c.appendChild(div);
            });
            document.getElementById('global-totals-container').style.display = savedTours.length ? "flex" : "none";
            document.getElementById('gt-ca').innerText = Math.round(gCA)+" ‚Ç¨"; document.getElementById('gt-cost').innerText = Math.round(gCost)+" ‚Ç¨"; document.getElementById('gt-dist').innerText = Math.round(gDist)+" km"; document.getElementById('gt-time').innerText = formatMin(gTime); document.getElementById('gt-ratio').innerText = gCA>0 ? (gCost/gCA*100).toFixed(1)+" %" : "0 %";
        }

        function saveCurrentTour() {
            if(!document.getElementById('tName').value) return alert("Nom manquant");
            const t = { id: currentTourId || Date.now().toString(), name: document.getElementById('tName').value, day: document.getElementById('tDay').value, stops: stops, stats: {...currentStats} };
            const i = savedTours.findIndex(x => x.id === t.id); if(i>=0) savedTours[i]=t; else savedTours.push(t);
            localStorage.setItem('v84_tours', JSON.stringify(savedTours)); saveDepot(); renderTours(); alert("Tourn√©e sauvegard√©e !");
        }
        function loadTour(id) { const t = savedTours.find(x=>x.id===id); if(t) { currentTourId=t.id; document.getElementById('tName').value=t.name; document.getElementById('tDay').value=t.day; stops=t.stops; updateView(); } }
        function newTour() { if(confirm("Nouvelle tourn√©e ?")) { currentTourId=null; stops=[]; updateView(); autoNameTour(); } }
        function deleteTour(id) { if(confirm("Supprimer ?")) { savedTours=savedTours.filter(x=>x.id!==id); localStorage.setItem('v84_tours', JSON.stringify(savedTours)); if(currentTourId===id) newTour(); else renderTours(); } }

        function checkProducerValidation() {
            let ok = document.getElementById('pName').value && pData.lat;
            let b = document.getElementById('prod-band');
            if(ok) { b.classList.add('validated'); document.getElementById('btn-validate-depot').disabled=false; document.getElementById('btn-validate-depot').style.opacity=1; }
            saveDepot();
        }
        function lockDepot() { document.getElementById('header-form').style.display='none'; document.getElementById('header-summary').style.display='flex'; document.getElementById('summary-content').innerText = `‚úÖ ${document.getElementById('pName').value} | ${pData.addr.split(',')[0]}`; document.getElementById('locked-section').style.opacity=1; document.getElementById('locked-section').style.pointerEvents='auto'; setTimeout(()=>map.invalidateSize(),200); }
        function unlockDepot() { document.getElementById('header-form').style.display='block'; document.getElementById('header-summary').style.display='none'; document.getElementById('locked-section').style.opacity=0.5; document.getElementById('locked-section').style.pointerEvents='none'; }
        
        function onMapClick(e) { fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`).then(r=>r.json()).then(d=>{ if(document.getElementById('header-form').style.display!=='none'){ pData={lat:e.latlng.lat, lon:e.latlng.lng, addr:d.display_name, name:document.getElementById('pName').value}; document.getElementById('pAddr').value=d.display_name; checkProducerValidation(); updateView(); } else { sTemp={lat:e.latlng.lat, lon:e.latlng.lng}; document.getElementById('sAddr').value=d.display_name; L.circleMarker(e.latlng, {color:'red'}).addTo(markers); } }); }
        function searchAddress(t) { let q=document.getElementById(t==='prod'?'pAddr':'sAddr').value; fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`).then(r=>r.json()).then(d=>{ if(d[0]) { let ll=[d[0].lat, d[0].lon]; map.setView(ll,14); if(t==='prod'){ pData={lat:ll[0], lon:ll[1], addr:d[0].display_name}; document.getElementById('pAddr').value=d[0].display_name; checkProducerValidation(); updateView(); } else { sTemp={lat:ll[0], lon:ll[1]}; document.getElementById('sAddr').value=d[0].display_name; L.circleMarker(ll, {color:'red'}).addTo(markers); } } }); }

        function addStop() { if(!sTemp.lat) return alert("Position ?"); stops.push({ id:Date.now(), client:document.getElementById('sClient').value||"Client", icon:document.getElementById('sOpType').value, lat:sTemp.lat, lon:sTemp.lon, addr:document.getElementById('sAddr').value, euro:parseFloat(document.getElementById('sEuro').value)||0, vol:parseFloat(document.getElementById('sVol').value)||0, time:parseFloat(document.getElementById('sTime').value)||15 }); sTemp={lat:null}; document.getElementById('sAddr').value=""; updateView(); }
        function editStop(i) { let s=stops[i]; document.getElementById('sClient').value=s.client; document.getElementById('sEuro').value=s.euro; document.getElementById('sVol').value=s.vol; document.getElementById('sTime').value=s.time; sTemp={lat:s.lat, lon:s.lon}; stops.splice(i,1); updateView(); }
        function reorderStops() { let ns=[]; document.querySelectorAll('.stop-item').forEach(e=>ns.push(stops.find(s=>s.id==e.getAttribute('data-id')))); stops=ns; updateView(); }

        function updateView() {
            markers.clearLayers(); routeLayer.clearLayers(); document.getElementById('stops-list').innerHTML="";
            if(pData.lat) L.marker([pData.lat, pData.lon]).addTo(markers);
            stops.forEach((s,i) => {
                document.getElementById('stops-list').innerHTML += `<li class="stop-item" data-id="${s.id}"><div class="stop-content"><b>${i+1}</b> ${s.client}</div><div class="stop-meta"><span class="stop-dist-tag" id="d-${i}">...</span></div><div class="stop-actions"><button class="btn-icon" onclick="editStop(${i})">‚úèÔ∏è</button><button class="btn-icon" onclick="stops.splice(${i},1);updateView()">‚úï</button></div></li>`;
                L.circleMarker([s.lat, s.lon]).addTo(markers);
            });
            if(pData.lat && stops.length) calcRoute(); else updateStats(0,0);
        }

        function calcRoute() {
            let pts = [[pData.lon, pData.lat], ...stops.map(s=>[s.lon, s.lat]), [pData.lon, pData.lat]];
            fetch(`https://router.project-osrm.org/route/v1/driving/${pts.map(p=>p.join(',')).join(';')}?overview=full&geometries=geojson`).then(r=>r.json()).then(res=>{
                if(res.code==='Ok'){
                    let r=res.routes[0]; L.polyline(r.geometry.coordinates.map(c=>[c[1],c[0]]), {color:'blue'}).addTo(routeLayer); map.fitBounds(routeLayer.getBounds());
                    updateStats(r.distance/1000, r.duration/60);
                    r.legs.forEach((l,i) => { if(i<stops.length) document.getElementById(`d-${i}`).innerText = (l.distance/1000).toFixed(1)+"km"; });
                }
            });
        }

        function updateStats(km, min) {
            let ch = parseFloat(document.getElementById('cH').value)||0, conso = parseFloat(document.getElementById('vCons').value)||0, price = parseFloat(document.getElementById('fPrice').value)||0;
            let time = min + stops.reduce((a,b)=>a+b.time,0) + (parseFloat(document.getElementById('tPrep').value)||0) + (parseFloat(document.getElementById('tLoad').value)||0);
            let cost = (km/100*conso*price) + (time/60*ch);
            let ca = stops.reduce((a,b)=>a+b.euro,0);
            currentStats = { cost, ca, ratio: ca>0?(cost/ca*100).toFixed(1):0, dist:km.toFixed(1), time };
            document.getElementById('rTotal').innerText=cost.toFixed(0)+" ‚Ç¨"; document.getElementById('rVal').innerText=ca.toFixed(0)+" ‚Ç¨"; document.getElementById('rRatio').innerText=currentStats.ratio+" %";
            document.getElementById('rDist').innerText=km.toFixed(1)+" km"; document.getElementById('rCostTrans').innerText=(km/100*conso*price).toFixed(0)+" ‚Ç¨"; document.getElementById('rCostOps').innerText=(time/60*ch).toFixed(0)+" ‚Ç¨";
        }

        function sendProjectData() {
            const btn = document.querySelector('button[onclick="sendProjectData()"]');
            btn.innerText = "‚è≥ Envoi..."; btn.disabled = true;
            const dateStr = new Date().toISOString().split('T')[0];
            let rows = [];
            
            // CONSTRUIRE LES LIGNES SELON LE HEADER V84
            savedTours.forEach(t => {
                const base = {
                    Date: dateStr, Producteur: document.getElementById('pName').value, Tournee_Nom: t.name, Tournee_ID: t.id, Jour: t.day,
                    Vehicule: document.getElementById('vType').value, Conso: document.getElementById('vCons').value, Prix_Carb: document.getElementById('fPrice').value,
                    Cout_H: document.getElementById('cH').value, Depot_Nom: "Depot", Depot_Lat: pData.lat, Depot_Lon: pData.lon
                };
                // DEPART
                rows.push({...base, Ordre:0, Client_Nom:"D√©part", Type_Op:"Depot", Volume:0, CA:0, Temps_Arret:0});
                // ARRETS (Simplifi√© pour export sans recalcul route ligne par ligne ici)
                if(t.stops) t.stops.forEach((s,i) => {
                    rows.push({...base, Ordre:i+1, Client_Nom:s.client, Client_Adresse:s.addr, Client_Lat:s.lat, Client_Lon:s.lon, Type_Op:s.icon, Volume:s.vol, CA:s.euro, Temps_Arret:s.time});
                });
                // RETOUR
                rows.push({...base, Ordre:99, Client_Nom:"Retour", Type_Op:"Depot", Volume:0, CA:0, Temps_Arret:0});
            });

            fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({rows}) })
            .then(r=>{ if(r.ok) alert("Envoy√© !"); else alert("Erreur"); })
            .catch(e=>alert("Erreur r√©seau"))
            .finally(()=>{ btn.innerText="üöÄ ENVOYER LE PROJET (CSV)"; btn.disabled=false; });
        }
        
        function updateStatsTitle() {} // Placeholder
    </script>
</body>
</html>
