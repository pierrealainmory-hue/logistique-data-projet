<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saisie de Tourn√©e Compl√®te</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background: #f4f7f6; }
        .header-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .left-panel { flex: 1; min-width: 350px; }
        .right-panel { flex: 1.5; min-width: 350px; }
        
        /* Inputs */
        input, select { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: bold; color: #2c3e50; font-size: 0.9em; }
        .row-inputs { display: flex; gap: 10px; }
        .row-inputs > div { flex: 1; }

        /* Zone d'ajout d'arr√™t */
        .add-stop-box { background: #e8f6f3; padding: 20px; border-radius: 8px; border: 1px solid #1abc9c; margin-bottom: 20px; }
        .add-stop-box h3 { margin-top: 0; color: #16a085; border-bottom: 1px solid #a3e4d7; padding-bottom: 10px;}
        
        /* Recherche Adresse */
        .search-box { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn-search { background: #8e44ad; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; white-space: nowrap; }

        /* Liste des arr√™ts */
        #stops-list { list-style: none; padding: 0; }
        .stop-item { background: white; padding: 10px; margin-bottom: 8px; border-left: 5px solid #3498db; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.9em; }
        .stop-number { background: #3498db; color: white; min-width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-weight: bold; margin-right: 10px; display: inline-block;}
        
        /* Carte */
        #map { height: 600px; width: 100%; border-radius: 8px; border: 2px solid #bdc3c7; }
        
        /* Boutons */
        .btn-add { background: #2980b9; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1.1em;}
        .btn-save { background: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
        .btn-save:disabled { background: #95a5a6; cursor: not-allowed; }
        
        .helper-text { font-size: 0.8em; color: #e74c3c; font-style: italic; display: none; }
    </style>
</head>
<body>

    <div class="header-box">
        <h1>üöö Cr√©ation de Tourn√©e</h1>
        <div class="row-inputs">
            <div>
                <label>Nom du Producteur</label>
                <input type="text" id="prodName" placeholder="Votre nom">
            </div>
            <div>
                <label>Jour de Tourn√©e</label>
                <select id="prodDay">
                    <option value="Lundi">Lundi</option>
                    <option value="Mardi">Mardi</option>
                    <option value="Mercredi">Mercredi</option>
                    <option value="Jeudi">Jeudi</option>
                    <option value="Vendredi">Vendredi</option>
                </select>
            </div>
            <div>
                <label>Temps Chargement D√©part (min)</label>
                <input type="number" id="loadTime" placeholder="Ex: 30" min="0">
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            
            <div class="add-stop-box">
                <h3>‚ûï Ajouter un arr√™t</h3>
                
                <label>Localiser via Adresse (ou cliquer sur la carte)</label>
                <div class="search-box">
                    <input type="text" id="addressSearch" placeholder="Ex: 10 rue de la R√©publique, Lyon">
                    <button class="btn-search" onclick="searchAddress()">üîç Chercher</button>
                </div>

                <label>Nom Client / Lieu</label>
                <input type="text" id="stopClient" placeholder="Le Gourmet">
                
                <div class="row-inputs">
                    <div>
                        <label>Poids (kg)</label>
                        <input type="number" id="stopWeight" placeholder="Ex: 50">
                    </div>
                    <div>
                        <label>Montant (‚Ç¨)</label>
                        <input type="number" id="stopEuro" placeholder="Ex: 120">
                    </div>
                </div>

                <div>
                    <label>Temps d'arr√™t estim√© (min)</label>
                    <input type="number" id="stopTime" placeholder="Ex: 15">
                </div>
                
                <div id="latlon-preview" style="color: #7f8c8d; font-size: 0.8em; margin-bottom: 10px; text-align: right;">Coordonn√©es : En attente...</div>
                
                <button class="btn-add" onclick="addStop()">Valider cet arr√™t</button>
                <p id="error-msg" class="helper-text">‚ö†Ô∏è Remplissez le Client, le Poids et cliquez sur la carte !</p>
            </div>

            <h3>üìã Liste (<span id="count">0</span> arr√™ts)</h3>
            <ul id="stops-list"></ul>

            <button class="btn-save" id="finalBtn" onclick="sendTournee()" disabled>üöÄ ENVOYER LA TOURN√âE</button>
            <div id="status-msg" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
        </div>

        <div class="right-panel">
            <div id="map"></div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://update-github-csv-149052175314.europe-west1.run.app/"; 

    let tourneeStops = [];
    let tempMarker = null;
    let mapMarkers = [];
    let polyline = null;
    let currentAddressTxt = "Saisie Carte"; // Stocke l'adresse trouv√©e

    var map = L.map('map').setView([46.603354, 1.888334], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    // Fonction de recherche d'adresse (OpenStreetMap Nominatim)
    function searchAddress() {
        let query = document.getElementById('addressSearch').value;
        if(query.length < 3) return;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if(data && data.length > 0) {
                let lat = data[0].lat;
                let lon = data[0].lon;
                currentAddressTxt = query; // On garde le texte saisi
                
                // Simuler un clic sur la carte √† cet endroit
                updateTempMarker(lat, lon);
                map.setView([lat, lon], 15); // Zoom sur le lieu
            } else {
                alert("Adresse non trouv√©e. Essayez d'√™tre plus pr√©cis.");
            }
        })
        .catch(err => alert("Erreur de recherche"));
    }

    // Gestion du clic carte
    map.on('click', function(e) {
        currentAddressTxt = "Point√© sur la carte";
        updateTempMarker(e.latlng.lat, e.latlng.lng);
    });

    function updateTempMarker(lat, lon) {
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker([lat, lon], {opacity: 0.7}).addTo(map);
        
        let el = document.getElementById('latlon-preview');
        el.dataset.lat = parseFloat(lat).toFixed(6);
        el.dataset.lon = parseFloat(lon).toFixed(6);
        el.innerText = `üìç ${parseFloat(lat).toFixed(4)}, ${parseFloat(lon).toFixed(4)}`;
        el.style.color = "green";
    }

    function addStop() {
        // R√©cup√©ration des champs
        let client = document.getElementById('stopClient').value;
        let poids = document.getElementById('stopWeight').value;
        let montant = document.getElementById('stopEuro').value;
        let tempsArret = document.getElementById('stopTime').value;
        
        // Coordonn√©es
        let el = document.getElementById('latlon-preview');
        let lat = el.dataset.lat;
        let lon = el.dataset.lon;

        if (!client || !poids || !lat) {
            document.getElementById('error-msg').style.display = 'block';
            return;
        }
        document.getElementById('error-msg').style.display = 'none';

        // Ajout donn√©es
        let stopData = { 
            client: client, 
            poids: poids, 
            montant: montant || 0, // 0 si vide
            temps_arret: tempsArret || 0,
            adresse_txt: currentAddressTxt,
            lat: lat, 
            lon: lon 
        };
        tourneeStops.push(stopData);

        // Ajout Visuel Liste
        let li = document.createElement('li');
        li.className = 'stop-item';
        li.innerHTML
