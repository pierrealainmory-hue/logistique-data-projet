<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistique Producteur - V21</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --bg: #eaeff2; --danger: #e74c3c; --info: #2980b9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: var(--bg); color: #333; font-size: 13px; }
        
        .header-band { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-top: 6px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .left-panel { flex: 1; min-width: 400px; }
        .right-panel { flex: 1.5; min-width: 400px; }

        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .active-zone { background: #fffbf0 !important; border: 2px solid var(--accent) !important; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .form-group label { display: block; font-weight: bold; color: #7f8c8d; margin-bottom: 5px; font-size: 0.8rem; }
        input, select { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; }
        
        .search-bar { display: flex; gap: 5px; }
        .btn-mini { padding: 8px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-target { background: #95a5a6; min-width: 40px; }
        .btn-target.active { background: var(--accent); }

        #stops-list { list-style: none; padding: 0; }
        .stop-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; border-left: 5px solid #3498db; align-items: center; }

        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .res-item { background: var(--primary); color: white; padding: 10px; border-radius: 8px; text-align: center; }
        .cost-card { padding: 12px; border-radius: 8px; color: white; text-align: center; flex: 1; }
        
        #map { height: 450px; width: 100%; border-radius: 12px; border: 1px solid #ccc; background: #eee; }
        .btn-main { background: var(--success); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <button onclick="localStorage.clear(); location.reload();" class="btn-mini" style="float:right; background:var(--danger)">ğŸ§¹ Reset</button>
    <h2 style="color: var(--primary);">ğŸš› Simulateur Logistique V21</h2>

    <div class="header-band" id="box-prod" onclick="setMode('prod')">
        <div class="grid">
            <div class="form-group" style="grid-column: span 2;">
                <label>Nom Producteur</label>
                <input type="text" id="pName" placeholder="Nom de la ferme" onchange="saveProd()">
            </div>
            <div class="form-group">
                <label>ğŸ“… Jour de Livraison</label>
                <select id="pDay" onchange="saveProd()">
                    <option>Lundi</option><option>Mardi</option><option>Mercredi</option>
                    <option>Jeudi</option><option>Vendredi</option><option>Samedi</option>
                </select>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>ğŸ“ DÃ©part (DÃ©pÃ´t)</label>
                <div class="search-bar">
                    <input type="text" id="pAddr" placeholder="Saisir adresse ou cliquer ğŸ¯">
                    <button class="btn-mini" style="background:var(--info)" onclick="searchAddress('prod')">ğŸ”</button>
                    <button class="btn-mini btn-target" id="btn-t-prod" onclick="setMode('prod'); event.stopPropagation();">ğŸ¯</button>
                </div>
            </div>
            <div class="form-group"><label>ğŸ“¦ PrÃ©p. (min)</label><input type="number" id="tPrep" value="30"></div>
            <div class="form-group"><label>ğŸšš Charg. (min)</label><input type="number" id="tLoad" value="20"></div>
            <div class="form-group"><label>ğŸ’¶ MO (â‚¬/h)</label><input type="number" id="cH" value="15"></div>
            <div class="form-group"><label>â›½ Carb. (â‚¬/km)</label><input type="number" id="cK" value="0.5" step="0.1"></div>
            <div class="form-group"><label>VÃ©hicule</label><select id="vType"><option>Petit</option><option>Moyen</option><option>Grand</option></select></div>
            <div class="form-group"><label>Ã‰nergie</label><select id="fType"><option>Diesel</option><option>Essence</option><option>Ã‰lectrique</option></select></div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="card" id="box-stop" onclick="setMode('stop')" style="border-left: 6px solid #1abc9c;">
                <h3>â• Ajouter un ArrÃªt</h3>
                <div class="form-group">
                    <label>ğŸ“ Localisation</label>
                    <div class="search-bar">
                        <input type="text" id="sAddr" placeholder="Saisir adresse ou cliquer ğŸ¯">
                        <button class="btn-mini" style="background:var(--info)" onclick="searchAddress('stop')">ğŸ”</button>
                        <button class="btn-mini btn-target" id="btn-t-stop" onclick="setMode('stop'); event.stopPropagation();">ğŸ¯</button>
                    </div>
                </div>
                <div class="grid" style="margin-top:10px;">
                    <div class="form-group" style="grid-column: span 2;"><label>Client</label><input type="text" id="sClient"></div>
                    <div class="form-group"><label>Valeur (â‚¬)</label><input type="number" id="sEuro" value="0"></div>
                    <div class="form-group"><label>â±ï¸ ArrÃªt (m)</label><input type="number" id="sTime" value="15"></div>
                </div>
                <button class="btn-main" style="background:#2980b9;" onclick="addStop()">Ajouter Ã  la tournÃ©e</button>
            </div>
            <ul id="stops-list"></ul>
            <button class="btn-main" id="btnSend" onclick="sendData()" disabled>ğŸš€ ENREGISTRER LA TOURNÃ‰E</button>
        </div>

        <div class="right-panel">
            <div id="map"></div>
            <div class="res-grid" style="margin-top:15px;">
                <div class="res-item"><span>ğŸ›£ï¸ Dist.</span><b id="rDist">0 km</b></div>
                <div class="res-item"><span>Conduite</span><b id="rTime">0h00</b></div>
                <div class="res-item"><span>Manut.</span><b id="rOps">0h00</b></div>
                <div class="cost-card" style="background:#2980b9;"><span>ğŸš› Transport</span><b id="rCostTrans">0 â‚¬</b></div>
                <div class="cost-card" style="background:#8e44ad;"><span>ğŸ¤ Manut.</span><b id="rCostOps">0 â‚¬</b></div>
                <div class="cost-card" style="background:var(--danger);"><span>ğŸ’° TOTAL</span><b id="rTotal">0 â‚¬</b></div>
                <div style="grid-column: span 3; background:var(--accent); color:white; padding:10px; border-radius:8px; display:flex; justify-content:space-around;">
                    <div>Valeur: <b id="rVal">0 â‚¬</b></div>
                    <div>Ratio: <b id="rRatio">0 %</b></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://update-github-csv-149052175314.europe-west1.run.app/";
        let map, markers, routeLayer;
        let stops = [];
        let mode = 'stop';
        let pData = { lat:null, lon:null, addr:"" };
        let sTemp = { lat:null, lon:null };

        window.onload = function() {
            map = L.map('map').setView([46.6, 1.88], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers = L.layerGroup().addTo(map);
            routeLayer = L.layerGroup().addTo(map);
            map.on('click', onMapClick);
            
            let saved = localStorage.getItem('pMem_v21');
            if(saved) {
                pData = JSON.parse(saved);
                document.getElementById('pName').value = pData.name || "";
                document.getElementById('pAddr').value = pData.addr || "";
                if(pData.day) document.getElementById('pDay').value = pData.day;
                updateView();
            }
            setMode('stop');
        };

        function setMode(m) {
            mode = m;
            document.getElementById('btn-t-prod').classList.toggle('active', m==='prod');
            document.getElementById('btn-t-stop').classList.toggle('active', m==='stop');
            document.getElementById('box-prod').classList.toggle('active-zone', m==='prod');
            document.getElementById('box-stop').classList.toggle('active-zone', m==='stop');
        }

        function onMapClick(e) {
            let lat = e.latlng.lat; let lon = e.latlng.lng;
            showTempPoint(lat, lon);
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json()).then(d => {
                    let a = d.display_name || "Point Carte";
                    if(mode === 'prod') {
                        pData = { lat, lon, addr: a, name: document.getElementById('pName').value, day: document.getElementById('pDay').value };
                        document.getElementById('pAddr').value = a;
                        saveProd();
                    } else {
                        sTemp = { lat, lon };
                        document.getElementById('sAddr').value = a;
                    }
                });
        }

        function searchAddress(target) {
            let q = document.getElementById(target === 'prod' ? 'pAddr' : 'sAddr').value;
            if(q.length < 3) return alert("Adresse trop courte");
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`)
                .then(r => r.json()).then(res => {
                    if(res.length > 0) {
                        let lat = parseFloat(res[0].lat), lon = parseFloat(res[0].lon);
                        showTempPoint(lat, lon);
                        map.setView([lat, lon], 14);
                        if(target === 'prod') {
                            pData = { lat, lon, addr: res[0].display_name, name: document.getElementById('pName').value, day: document.getElementById('pDay').value };
                            document.getElementById('pAddr').value = res[0].display_name;
                            saveProd();
                        } else {
                            sTemp = { lat, lon };
                            document.getElementById('sAddr').value = res[0].display_name;
                        }
                    } else alert("Non trouvÃ©");
                });
        }

        function showTempPoint(lat, lon) {
            markers.clearLayers();
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'ğŸ ', className:''})}).addTo(markers);
            stops.forEach(s => L.circleMarker([s.lat, s.lon], {radius:8, color:'blue', fillOpacity:1}).addTo(markers));
            L.circleMarker([lat, lon], {radius:10, color:'orange', weight:3, fillOpacity:0.5}).addTo(markers);
        }

        function saveProd() {
            pData.name = document.getElementById('pName').value;
            pData.day = document.getElementById('pDay').value;
            localStorage.setItem('pMem_v21', JSON.stringify(pData));
            updateView();
        }

        function addStop() {
            if(!pData.lat) return alert("DÃ©fisissez le Producteur !");
            if(!sTemp.lat) return alert("Pointez l'arrÃªt !");
            stops.push({
                client: document.getElementById('sClient').value || "Client",
                euro: parseFloat(document.getElementById('sEuro').value) || 0,
                time: parseFloat(document.getElementById('sTime').value) || 15,
                lat: sTemp.lat, lon: sTemp.lon
            });
            sTemp = { lat:null, lon:null };
            document.getElementById('sAddr').value = "";
            document.getElementById('sClient').value = "";
            updateView();
        }

        function updateView() {
            markers.clearLayers();
            routeLayer.clearLayers();
            let ul = document.getElementById('stops-list');
            ul.innerHTML = "";
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'ğŸ ', className:''})}).addTo(markers);
            stops.forEach((s, i) => {
                ul.innerHTML += `<li class="stop-item"><span><b>${i+1}.</b> ${s.client}</span><button onclick="stops.splice(${i},1); updateView()" style="color:red; border:none; background:none; cursor:pointer;">âœ•</button></li>`;
                L.circleMarker([s.lat, s.lon], {radius:8, color:'blue', fillOpacity:1}).addTo(markers);
            });
            if(pData.lat && stops.length > 0) calcRoute();
            document.getElementById('btnSend').disabled = (stops.length === 0);
        }

        function calcRoute() {
            let pts = [[pData.lon, pData.lat], ...stops.map(s => [s.lon, s.lat]), [pData.lon, pData.lat]];
            fetch(`https://router.project-osrm.org/route/v1/driving/${pts.map(p => p.join(',')).join(';')}?overview=full&geometries=geojson`)
                .then(r => r.json()).then(res => {
                    if(res.code === 'Ok') {
                        let rData = res.routes[0];
                        L.polyline(rData.geometry.coordinates.map(c => [c[1], c[0]]), {color:'blue', weight:4}).addTo(routeLayer);
                        map.fitBounds(L.featureGroup(markers.getLayers()).getBounds().pad(0.1));
                        updateStats(rData.distance/1000, rData.duration/60);
                    }
                });
        }

        function updateStats(dist = 0, driveTime = 0) {
            let prep = parseFloat(document.getElementById('tPrep').value) || 0;
            let load = parseFloat(document.getElementById('tLoad').value) || 0;
            let sTime = stops.reduce((a, b) => a + b.time, 0);
            let totalOps = prep + load + sTime;
            let cH = parseFloat(document.getElementById('cH').value) || 15, cK = parseFloat(document.getElementById('cK').value) || 0.5;
            let cTrans = (dist * cK) + ((driveTime / 60) * cH), cOps = (totalOps / 60) * cH;
            let total = cTrans + cOps, val = stops.reduce((a, b) => a + b.euro, 0);

            document.getElementById('rDist').innerText = dist.toFixed(1) + " km";
            document.getElementById('rTime').innerText = Math.floor(driveTime/60) + "h" + Math.round(driveTime%60);
            document.getElementById('rOps').innerText = Math.floor(totalOps/60) + "h" + Math.round(totalOps%60);
            document.getElementById('rCostTrans').innerText = cTrans.toFixed(1) + " â‚¬";
            document.getElementById('rCostOps').innerText = cOps.toFixed(1) + " â‚¬";
            document.getElementById('rTotal').innerText = total.toFixed(0) + " â‚¬";
            document.getElementById('rVal').innerText = val + " â‚¬";
            document.getElementById('rRatio').innerText = val > 0 ? (total/val*100).toFixed(1) + " %" : "0 %";
        }

        function sendData() {
            let btn = document.getElementById('btnSend');
            btn.disabled = true; btn.innerText = "Envoi...";
            let payload = {
                general: { 
                    Producteur: document.getElementById('pName').value, 
                    Jour: document.getElementById('pDay').value,
                    CoutHoraire: parseFloat(document.getElementById('cH').value),
                    CoutKm: parseFloat(document.getElementById('cK').value),
                    TempsPreparation: parseFloat(document.getElementById('tPrep').value),
                    TempsChargement: parseFloat(document.getElementById('tLoad').value),
                    Vehicule: document.getElementById('vType').value,
                    CoutTotal: document.getElementById('rTotal').innerText,
                    ValeurMarchandise: document.getElementById('rVal').innerText
                },
                stops: stops
            };
            fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(r => { if(!r.ok) throw new Error(); return r.json(); })
            .then(() => { alert("âœ… EnregistrÃ© !"); stops = []; updateView(); })
            .catch(() => alert("âŒ Erreur envoi"))
            .finally(() => { btn.disabled = false; btn.innerText = "ğŸš€ ENREGISTRER LA TOURNÃ‰E"; });
        }
    </script>
</body>
</html>
