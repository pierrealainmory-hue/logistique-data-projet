<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©crire une Tourn√©e (V3 Stable)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1400px; margin: 0 auto; padding: 15px; background: #eaeff2; color: #333; font-size: 14px; }
        
        /* HEADER */
        .header-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 6px solid #95a5a6; }
        .header-box.saved { border-left-color: #27ae60; background: #f0fdf4; }
        .header-title { font-size: 1.5em; color: #2c3e50; margin-bottom: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #memory-badge { font-size: 0.6em; background: #ecf0f1; padding: 5px 12px; border-radius: 15px; color: #7f8c8d; }
        .header-box.saved #memory-badge { background: #27ae60; color: white; }

        .grid-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-weight: 700; color: #7f8c8d; margin-bottom: 5px; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; box-sizing: border-box; }
        .input-valid { border-color: #2ecc71 !important; background-color: #e8f8f5 !important; }

        /* LAYOUT */
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        .left-panel { flex: 1; min-width: 400px; }
        .right-panel { flex: 1.5; min-width: 400px; display: flex; flex-direction: column; }
        .add-stop-box { background: white; padding: 20px; border-radius: 8px; border-top: 5px solid #1abc9c; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* LISTE ARRETS (CORRIG√âE) */
        #stops-list { list-style: none; padding: 0; margin: 0; max-height: 500px; overflow-y: auto; }
        .stop-item { 
            background: white; 
            padding: 12px 15px; 
            margin-bottom: 12px; /* Espace entre les items */
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-left: 5px solid #bdc3c7; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 50px; /* Hauteur min garantie */
        }
        .stop-item.type-livraison { border-left-color: #3498db; }
        .stop-item.type-point-relais { border-left-color: #f39c12; }
        .stop-item.type-collecte { border-left-color: #9b59b6; }

        /* BUTTONS & MAP */
        .search-bar { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn-mini { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-search { background: #8e44ad; }
        .btn-target { background: #95a5a6; opacity: 0.6; }
        .btn-target.active { background: #e74c3c; opacity: 1; transform: scale(1.05); }
        .btn-gps { background: #e67e22; }

        #map { height: 600px; width: 100%; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 20px; cursor: crosshair; }

        /* SYNTHESE */
        .synthesis-box { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-group h4 { margin: 0 0 10px 0; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; color: #bdc3c7; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .total-cost-row { grid-column: span 2; background: #34495e; padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2em; border-left: 5px solid #e74c3c; margin-top: 5px; }
        .ratio-box { grid-column: span 2; background: #e67e22; padding: 10px; border-radius: 6px; text-align: center; margin-top: 5px; }
        .ratio-box b { font-size: 1.4em; display: block; }

        .btn-add { background: #2980b9; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 10px; }
        .btn-save { background: #27ae60; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.3em; margin-top: 10px; }
        .btn-save:disabled { background: #95a5a6; cursor: not-allowed; }
        .coords-feedback { font-size: 0.8em; color: #27ae60; font-weight: bold; display: none; margin-top: 4px; }
        .warning-text { color: #e74c3c; font-size: 0.8em; margin-top: 2px; display: none; }
    </style>
</head>
<body>

    <div class="header-box" id="header-box">
        <div class="header-title">
            <span>üìù D√©crire une Tourn√©e (Producteur)</span>
            <span id="memory-badge">En attente...</span>
        </div>
        
        <div class="grid-header" onchange="saveProdData()">
            <div class="form-group"><label>Nom Producteur</label><input type="text" id="prodName" placeholder="Ex: Ferme du Val"></div>
            <div class="form-group">
                <label>Jour</label>
                <select id="prodDay">
                    <option value="Lundi">Lundi</option><option value="Mardi">Mardi</option><option value="Mercredi">Mercredi</option><option value="Jeudi">Jeudi</option><option value="Vendredi">Vendredi</option>
                </select>
            </div>
            
            <div class="form-group" style="grid-column: span 2;">
                <label>üìç Adresse de D√âPART (D√©p√¥t)</label>
                <div class="search-bar">
                    <input type="text" id="prodAddress" placeholder="Adresse..." onfocus="setMapTarget('prod')" onchange="geocodeInput('prod')">
                    <button class="btn-mini btn-search" onclick="geocodeInput('prod')">üîç</button>
                    <button class="btn-mini btn-target" id="btn-target-prod" onclick="event.stopPropagation(); setMapTarget('prod')">üéØ CIBLER</button>
                    <button class="btn-mini btn-gps" onclick="geolocate('prod')">üìç GPS</button>
                </div>
                <div id="feedback-prod" class="coords-feedback">‚úÖ Coordonn√©es OK</div>
                <div id="warn-prod" class="warning-text">‚ö†Ô∏è Veuillez valider l'adresse (üîç)</div>
                <input type="hidden" id="prodLat"><input type="hidden" id="prodLon">
            </div>

            <div class="form-group"><label>Tps Pr√©pa (min)</label><input type="number" id="prepTime" value="0"></div>
            <div class="form-group"><label>Tps Chargement (min)</label><input type="number" id="loadTime" value="30"></div>
            <div class="form-group"><label>Co√ªt Main d'Oeuvre (‚Ç¨/h)</label><input type="number" id="costHour" value="15"></div>
            <div class="form-group"><label>Co√ªt V√©hicule (‚Ç¨/km)</label><input type="number" id="costKm" value="0.5"></div>
            
            <div class="form-group" style="grid-column: span 2;">
                <label>Type V√©hicule</label>
                <select id="vehicleType">
                    <option value="<3m3">Moins de 3m¬≥ (Petit utilitaire)</option>
                    <option value="3-6m3">De 3m¬≥ √† 6m¬≥ (Fourgon compact)</option>
                    <option value="6-12m3">De 6m¬≥ √† 12m¬≥ (Grand fourgon)</option>
                    <option value="12-20m3">De 12m¬≥ √† 20m¬≥ (Tr√®s grand fourgon)</option>
                    <option value=">20m3">Plus de 20m¬≥ (Camion)</option>
                </select>
            </div>
            <div class="form-group"><label>Carburant</label><select id="fuelType"><option value="Diesel">Diesel</option><option value="Essence">Essence</option><option value="Electrique">√âlectrique</option></select></div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="add-stop-box" onclick="setMapTarget('stop')">
                <h3>‚ûï Ajouter un Point d'Arr√™t</h3>
                <div class="form-group">
                    <label>Localisation</label>
                    <div class="search-bar">
                        <input type="text" id="stopAddress" placeholder="Adresse..." onfocus="setMapTarget('stop')" onkeypress="if(event.key==='Enter') geocodeInput('stop')">
                        <button class="btn-mini btn-search" onclick="geocodeInput('stop')">üîç</button>
                        <button class="btn-mini btn-target" id="btn-target-stop" onclick="event.stopPropagation(); setMapTarget('stop')">üéØ CIBLER</button>
                    </div>
                    <div id="feedback-stop" class="coords-feedback">‚úÖ Coordonn√©es r√©cup√©r√©es</div>
                    <input type="hidden" id="stopLat"><input type="hidden" id="stopLon">
                </div>
                <div class="form-group">
                    <label>Type d'op√©ration</label>
                    <select id="stopType" style="background:#f0f8ff; font-weight:bold;">
                        <option value="Livraison">üì¶ Livraison Client</option>
                        <option value="Point Relais">üè¨ Point Relais</option>
                        <option value="Collecte">üöú Collecte Producteur</option>
                    </select>
                </div>
                <div class="form-group"><label>Nom (Client/Lieu)</label><input type="text" id="stopClient" placeholder="Ex: Resto le Gourmet"></div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group"><label>Poids approx. (kg)</label><input type="number" id="stopWeight" placeholder="Ex: 50"></div>
                    <div class="form-group"><label>Montant approx. (‚Ç¨)</label><input type="number" id="stopEuro" placeholder="Ex: 120"></div>
                </div>
                <div class="form-group"><label>Temps d'arr√™t sur place (min)</label><input type="number" id="stopTime" value="15"></div>
                <button class="btn-add" onclick="addStop()">Valider cet arr√™t</button>
                <p id="error-msg" style="color:red; display:none; text-align:center; font-weight:bold; margin-top:5px;">‚ö†Ô∏è Erreur : Localisation ou Nom manquant !</p>
            </div>

            <div style="background:white; padding:10px; border-radius:8px;">
                <h4 style="margin:0 0 10px 0;">üìã Liste des arr√™ts</h4>
                <ul id="stops-list"></ul>
            </div>
            <button class="btn-save" id="finalBtn" onclick="sendTournee()" disabled>üöÄ ENREGISTRER LA TOURN√âE</button>
        </div>

        <div class="right-panel">
            <div id="map"></div>
            <div class="synthesis-box">
                <div class="stat-group">
                    <h4>üöö TRANSPORT</h4>
                    <div class="stat-row"><span>Distance</span><b id="syn-dist">0 km</b></div>
                    <div class="stat-row"><span>Temps Conduite</span><b id="syn-time-drive">0h00</b></div>
                    <div class="stat-row"><span>Co√ªt Km</span><b id="syn-cost-trans">0 ‚Ç¨</b></div>
                </div>
                <div class="stat-group">
                    <h4>‚è±Ô∏è OP√âRATIONS</h4>
                    <div class="stat-row"><span>Tps Service (Pr√©pa+Arr√™ts)</span><b id="syn-time-ops">0h00</b></div>
                    <div class="stat-row"><span>Co√ªt Main d'Oeuvre</span><b id="syn-cost-mo">0 ‚Ç¨</b></div>
                </div>
                <div class="total-cost-row">
                    <span>CO√õT TOTAL LOGISTIQUE</span><b id="syn-cost-total">0 ‚Ç¨</b>
                </div>
                <div class="ratio-box">
                    <span>Ratio Co√ªt / Valeur Marchandise</span><b id="syn-ratio">0 %</b>
                    <span style="font-size:0.8em; font-weight:normal;" id="syn-rev-display">(Valeur: 0‚Ç¨)</span>
                </div>
            </div>
        </div>
    </div>

<script>
    const API_URL = "https://update-github-csv-149052175314.europe-west1.run.app/"; 

    let stops = [];
    let mapMarkers = []; 
    let routeLayer = null;
    let fallbackLayer = null; 
    let tempMarker = null;
    let prodMarker = null;
    let activeTarget = 'stop'; 
    
    // Init Carte
    var map = L.map('map').setView([46.60, 1.88], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);

    // --- 1. MEMOIRE & CHARGEMENT ---
    window.onload = function() { loadProdData(); };

    function saveProdData() {
        let data = {
            name: document.getElementById('prodName').value,
            address: document.getElementById('prodAddress').value,
            lat: document.getElementById('prodLat').value,
            lon: document.getElementById('prodLon').value,
            prep: document.getElementById('prepTime').value,
            load: document.getElementById('loadTime').value,
            ch: document.getElementById('costHour').value,
            ck: document.getElementById('costKm').value,
            veh: document.getElementById('vehicleType').value,
            fuel: document.getElementById('fuelType').value
        };
        localStorage.setItem('logistique_prod_data', JSON.stringify(data));
        checkHeaderStatus();
        
        if(data.lat && data.lon) {
            placeProdMarker(data.lat, data.lon);
            // Si on a des stops, on recalcule la route
            if(stops.length > 0) processRoute(); 
        }
    }

    function loadProdData() {
        let saved = localStorage.getItem('logistique_prod_data');
        if(saved) {
            let data = JSON.parse(saved);
            document.getElementById('prodName').value = data.name || "";
            document.getElementById('prodAddress').value = data.address || "";
            document.getElementById('prodLat').value = data.lat || "";
            document.getElementById('prodLon').value = data.lon || "";
            document.getElementById('prepTime').value = data.prep || 0;
            document.getElementById('loadTime').value = data.load || 30;
            document.getElementById('costHour').value = data.ch || 15;
            document.getElementById('costKm').value = data.ck || 0.5;
            
            checkHeaderStatus();
            if(data.lat && data.lon) {
                placeProdMarker(data.lat, data.lon);
                map.setView([data.lat, data.lon], 13);
                document.getElementById('feedback-prod').style.display = 'block';
            }
        }
    }

    function checkHeaderStatus() {
        let name = document.getElementById('prodName').value;
        let lat = document.getElementById('prodLat').value;
        let header = document.getElementById('header-box');
        let badge = document.getElementById('memory-badge');
        
        if(name && lat) {
            header.classList.add('saved');
            badge.innerText = "Donn√©es M√©moris√©es ‚úÖ";
        } else {
            header.classList.remove('saved');
            badge.innerText = "Donn√©es en attente...";
        }
    }

    // --- 2. CIBLAGE ---
    function setMapTarget(target) {
        activeTarget = target;
        document.getElementById('btn-target-prod').classList.remove('active');
        document.getElementById('btn-target-stop').classList.remove('active');
        document.getElementById('btn-target-' + target).classList.add('active');
    }

    // --- 3. GESTION CARTE ---
    function placeProdMarker(lat, lon) {
        if(prodMarker) map.removeLayer(prodMarker);
        prodMarker = L.marker([lat, lon], {
            icon: L.divIcon({html: '<div style="font-size:32px;">üè≠</div>', className: ''})
        }).addTo(map);
    }

    map.on('click', function(e) {
        if(tempMarker) map.removeLayer(tempMarker);
        
        let iconChar = activeTarget === 'prod' ? 'üè≠' : 'üìç';
        tempMarker = L.marker(e.latlng, {
            icon: L.divIcon({html: `<div style="font-size:32px; opacity:0.6;">${iconChar}</div>`, className: ''})
        }).addTo(map);
        
        let inputId = activeTarget === 'prod' ? 'prodAddress' : 'stopAddress';
        let feedbackId = activeTarget === 'prod' ? 'feedback-prod' : 'feedback-stop';
        let latId = activeTarget === 'prod' ? 'prodLat' : 'stopLat';
        let lonId = activeTarget === 'prod' ? 'prodLon' : 'stopLon';

        document.getElementById(inputId).value = "‚è≥ Recherche...";
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lon}`)
        .then(r => r.json())
        .then(data => {
            let addr = data.display_name || "Point Carte";
            document.getElementById(inputId).value = addr;
            document.getElementById(latId).value = e.latlng.lat;
            document.getElementById(lonId).value = e.latlng.lon;
            
            document.getElementById(inputId).classList.add('input-valid');
            document.getElementById(feedbackId).style.display = 'block';
            
            if(activeTarget === 'prod') {
                saveProdData(); // D√©clenche sauvegarde + processRoute si stops
            }
        });
    });

    function geocodeInput(target) {
        setMapTarget(target);
        let inputId = target === 'prod' ? 'prodAddress' : 'stopAddress';
        let q = document.getElementById(inputId).value;
        if(q.length < 3) return;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
        .then(r=>r.json()).then(d=>{
            if(d.length>0) {
                map.fireEvent('click', {latlng: {lat:d[0].lat, lng:d[0].lon}});
                map.setView([d[0].lat, d[0].lon], 16);
            } else alert("Introuvable");
        });
    }
    
    function geolocate(target) {
        setMapTarget(target);
        navigator.geolocation.getCurrentPosition(p => {
            map.fireEvent('click', {latlng: {lat:p.coords.latitude, lng:p.coords.longitude}});
            map.setView([p.coords.latitude, p.coords.longitude], 16);
        });
    }

    // --- 4. LISTE STOPS ---
    function addStop() {
        let pLat = document.getElementById('prodLat').value;
        if(!pLat) {
            document.getElementById('warn-prod').style.display='block';
            alert("‚ö†Ô∏è Veuillez d'abord valider (üîç) l'adresse de d√©part du Producteur !");
            return;
        }

        let lat = document.getElementById('stopLat').value;
        let client = document.getElementById('stopClient').value;
        
        if(!lat || !client) {
            document.getElementById('error-msg').style.display='block'; return;
        }
        document.getElementById('error-msg').style.display='none';
        
        stops.push({
            type: document.getElementById('stopType').value,
            client: client,
            poids: parseFloat(document.getElementById('stopWeight').value)||0,
            montant: parseFloat(document.getElementById('stopEuro').value)||0,
            temps_arret: parseFloat(document.getElementById('stopTime').value)||0,
            lat: lat,
            lon: document.getElementById('stopLon').value,
            adresse_txt: document.getElementById('stopAddress').value
        });
        
        // Reset Inputs
        document.getElementById('stopClient').value = '';
        document.getElementById('stopWeight').value = '';
        document.getElementById('stopEuro').value = '';
        document.getElementById('stopAddress').value = '';
        document.getElementById('stopLat').value = ''; 
        document.getElementById('stopAddress').classList.remove('input-valid');
        document.getElementById('feedback-stop').style.display = 'none';
        if(tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        
        refreshUI();
    }

    function refreshUI() {
        let ul = document.getElementById('stops-list');
        ul.innerHTML = "";
        
        mapMarkers.forEach(m => map.removeLayer(m));
        mapMarkers = [];

        stops.forEach((s, i) => {
            let li = document.createElement('li');
            let cls = 'stop-item';
            if(s.type === 'Livraison') cls += ' type-livraison';
            else if(s.type === 'Point Relais') cls += ' type-point-relais';
            else cls += ' type-collecte';
            
            li.className = cls;
            li.innerHTML = `
                <div style="width:100%">
                    <strong>${i+1}. ${s.client}</strong> <span style="font-size:0.8em; color:#7f8c8d;">(${s.type})</span><br>
                    <span style="color:#555; font-size:0.9em;">~${s.poids}kg | ~${s.montant}‚Ç¨ | ${s.temps_arret}min</span>
                </div>
                <button onclick="removeStop(${i})" style="color:red; border:none; background:none; cursor:pointer; font-size:1.5em;">‚úï</button>
            `;
            ul.appendChild(li);
            
            let color = s.type === 'Livraison' ? '#3498db' : (s.type === 'Point Relais' ? '#f39c12' : '#9b59b6');
            let m = L.circleMarker([s.lat, s.lon], {radius: 8, fillColor: color, color: '#fff', weight: 2, fillOpacity: 1})
                     .bindPopup(`<b>${i+1}</b> ${s.client}`);
            m.addTo(map);
            mapMarkers.push(m);
        });

        document.getElementById('finalBtn').disabled = stops.length === 0;
        
        // Appeler la fonction principale de calcul
        processRoute();
    }
    
    function removeStop(i) {
        stops.splice(i, 1);
        refreshUI();
    }

    // --- 5. LOGIQUE DE CALCUL ROBUSTE ---
    // Cette fonction orchestre le calcul instantan√© PUIS le calcul pr√©cis
    function processRoute() {
        let pLat = document.getElementById('prodLat').value;
        let pLon = document.getElementById('prodLon').value;
        
        // Redessine toujours le producteur
        if(pLat) placeProdMarker(pLat, pLon);
        
        if(!pLat || stops.length === 0) {
            updateStats(0, 0); // Remise √† z√©ro
            if(routeLayer) map.removeLayer(routeLayer);
            if(fallbackLayer) map.removeLayer(fallbackLayer);
            return;
        }

        // 1. Calcul imm√©diat (Vol d'oiseau) pour ne jamais avoir z√©ro
        let coords = [`${pLon},${pLat}`];
        stops.forEach(s => coords.push(`${s.lon},${s.lat}`));
        coords.push(`${pLon},${pLat}`); // Boucle
        
        // Calcul manuel distance
        let rawDistKm = calculateGeoDistance(coords); 
        let rawTimeMin = (rawDistKm / 50) * 60; // Estimation 50km/h
        
        // Afficher ces stats tout de suite (en attendant mieux)
        updateStats(rawDistKm * 1.3, rawTimeMin); // *1.3 coeff tortuosit√©
        drawStraightLines(coords); // Lignes rouges en attendant

        // 2. Essai Routeur OSRM (Async)
        fetchRouteOSRM(coords);
    }

    function calculateGeoDistance(coords) {
        let total = 0;
        for(let i=0; i<coords.length-1; i++) {
            let [lon1, lat1] = coords[i].split(',').map(parseFloat);
            let [lon2, lat2] = coords[i+1].split(',').map(parseFloat);
            total += getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2);
        }
        return total;
    }

    function drawStraightLines(coords) {
        if(routeLayer) map.removeLayer(routeLayer);
        if(fallbackLayer) map.removeLayer(fallbackLayer);
        
        let latlngs = coords.map(c => {
            let [lon, lat] = c.split(',').map(parseFloat);
            return [lat, lon];
        });
        fallbackLayer = L.polyline(latlngs, {color: 'red', dashArray: '5, 10', weight: 3}).addTo(map);
        map.fitBounds(fallbackLayer.getBounds().pad(0.1));
    }

    async function fetchRouteOSRM(coords) {
        let url = `https://router.project-osrm.org/route/v1/driving/${coords.join(';')}?overview=full&geometries=geojson`;
        
        try {
            let res = await fetch(url).then(r=>r.json());
            if(res.code === "Ok" && res.routes && res.routes.length > 0) {
                // VICTOIRE : Route trouv√©e
                let r = res.routes[0];
                
                // On remplace les lignes rouges par la bleue
                if(fallbackLayer) map.removeLayer(fallbackLayer);
                if(routeLayer) map.removeLayer(routeLayer);
                
                let latlngs = r.geometry.coordinates.map(c => [c[1],c[0]]);
                routeLayer = L.polyline(latlngs, {color:'#2c3e50', weight:5, opacity:0.8}).addTo(map);
                
                // Mise √† jour pr√©cise des stats
                updateStats(r.distance / 1000, r.duration / 60);
            }
        } catch(e) {
            console.log("OSRM √©chec, on garde l'estimation vol d'oiseau");
        }
    }

    function updateStats(distKm, driveTimeMin) {
        let prepTime = parseFloat(document.getElementById('prepTime').value)||0;
        let loadTime = parseFloat(document.getElementById('loadTime').value)||0;
        let stopsTime = stops.reduce((acc, s) => acc + s.temps_arret, 0);
        
        let opsTimeMin = prepTime + loadTime + stopsTime;
        
        let costH = parseFloat(document.getElementById('costHour').value)||0;
        let costK = parseFloat(document.getElementById('costKm').value)||0;
        
        let costTrans = distKm * costK;
        let costMO = ((driveTimeMin + opsTimeMin) / 60) * costH;
        let totalCost = costTrans + costMO;

        let totalRev = stops.reduce((acc, s) => acc + s.montant, 0);
        let ratio = totalRev > 0 ? ((totalCost / totalRev) * 100).toFixed(1) : 0;

        // Update DOM
        document.getElementById('syn-dist').innerText = distKm.toFixed(1) + " km";
        document.getElementById('syn-time-drive').innerText = formatTime(driveTimeMin);
        document.getElementById('syn-time-ops').innerText = formatTime(opsTimeMin);
        
        document.getElementById('syn-cost-trans').innerText = costTrans.toFixed(0) + " ‚Ç¨";
        document.getElementById('syn-cost-mo').innerText = costMO.toFixed(0) + " ‚Ç¨";
        document.getElementById('syn-cost-total').innerText = totalCost.toFixed(0) + " ‚Ç¨";
        
        document.getElementById('syn-ratio').innerText = ratio + " %";
        document.getElementById('syn-rev-display').innerText = `(Valeur: ${totalRev}‚Ç¨)`;
    }

    function formatTime(min) {
        let h = Math.floor(min / 60);
        let m = Math.round(min % 60);
        return `${h}h${m<10?'0':''}${m}`;
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2); 
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    // --- 6. ENVOI ---
    function sendTournee() {
        if(!document.getElementById('prodLat').value) { alert("Adresse D√©p√¥t requise !"); return; }
        let btn = document.getElementById('finalBtn');
        btn.disabled = true; btn.innerText = "Envoi...";

        let payload = {
            general: {
                Producteur: document.getElementById('prodName').value,
                Jour: document.getElementById('prodDay').value,
                AdresseProd: document.getElementById('prodAddress').value,
                LatProd: document.getElementById('prodLat').value, 
                LonProd: document.getElementById('prodLon').value,
                TempsPreparation: parseFloat(document.getElementById('prepTime').value),
                TempsChargement: parseFloat(document.getElementById('loadTime').value),
                CoutHoraire: parseFloat(document.getElementById('costHour').value),
                CoutKm: parseFloat(document.getElementById('costKm').value),
                Vehicule: document.getElementById('vehicleType').value,
                Carburant: document.getElementById('fuelType').value
            },
            stops: stops
        };

        fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r=>r.json()).then(d => {
            if(d.success) { 
                alert("‚úÖ Tourn√©e enregistr√©e !"); 
                stops = []; 
                refreshUI(); 
                btn.innerText = "üöÄ ENREGISTRER LA TOURN√âE"; 
            } 
            else throw new Error(d.error);
        })
        .catch(e => { alert("Erreur: " + e.message); btn.disabled = false; });
    }
</script>
</body>
</html>
