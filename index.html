<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistique V33 - Test CSV Full-Data</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --bg: #f4f7f9; --info: #3498db; --text: #546e7a; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 20px; background: var(--bg); }
        .header-band { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid var(--primary); }
        .header-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { flex: 1; display: flex; flex-direction: column; gap: 5px; min-width: 130px; }
        .form-group label { font-weight: 600; color: var(--text); font-size: 0.75rem; }
        input, select { padding: 10px; border: 1px solid #dcdfe6; border-radius: 8px; font-size: 0.9rem; }
        .main-container { display: flex; gap: 20px; }
        .left-panel { flex: 1; min-width: 400px; }
        .right-panel { flex: 2; }
        #map { height: 400px; width: 100%; border-radius: 12px; border: 1px solid #dcdfe6; }
        .stop-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; border: 1px solid #ebedf0; }
        .btn-main { background: var(--success); color: white; width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-mini { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>üöõ Test d'Enregistrement CSV (V33)</h2>
        <button onclick="resetAll()" class="btn-mini" style="background:var(--danger); color:white;">R√©initialiser</button>
    </div>

    <div class="header-band">
        <div class="header-row">
            <div class="form-group"><label>Producteur</label><input type="text" id="pName" placeholder="Obligatoire" onchange="updateTitle()"></div>
            <div class="form-group"><label>Jour</label><select id="pDay"><option>Lundi</option><option>Mardi</option><option>Mercredi</option><option>Jeudi</option><option>Vendredi</option></select></div>
            <div class="form-group" style="flex: 2;"><label>üìç Adresse D√©p√¥t</label><div style="display:flex; gap:5px;"><input type="text" id="pAddr" placeholder="Rechercher..." style="flex:1;"><button class="btn-mini" style="background:var(--info); color:white" onclick="searchAddress('prod')">üîç</button><button class="btn-mini" id="btn-t-prod" style="background:#95a5a6; color:white" onclick="setMode('prod')">üéØ</button></div></div>
        </div>
        <div class="header-row">
            <div class="form-group"><label>V√©hicule</label><select id="vType"><option>Petit</option><option selected>Moyen</option><option>Grand</option></select></div>
            <div class="form-group"><label>Pr√©p (min)</label><input type="number" id="tPrep" value="30"></div>
            <div class="form-group"><label>Livreur (‚Ç¨/h)</label><input type="number" id="cH" value="18"></div>
            <div class="form-group"><label>Km (‚Ç¨/km)</label><input type="number" id="cK" value="0.6"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="card" style="background:white; padding:20px; border-radius:12px; border-left:5px solid var(--success); margin-bottom:20px;">
                <div class="form-group"><label>Client</label><input type="text" id="sClient"></div>
                <div class="form-group" style="margin-top:10px;"><label>Adresse Client</label><div style="display:flex; gap:5px;"><input type="text" id="sAddr" placeholder="Adresse..." style="flex:1;"><button class="btn-mini" style="background:var(--info); color:white" onclick="searchAddress('stop')">üîç</button><button class="btn-mini" id="btn-t-stop" style="background:#95a5a6; color:white" onclick="setMode('stop')">üéØ</button></div></div>
                <button class="btn-main" style="margin-top:15px; background:var(--info);" onclick="addStop()">Ajouter l'√©tape</button>
            </div>
            <ul id="stops-list"></ul>
            <button class="btn-main" id="btnSend" onclick="sendData()" disabled>üöÄ ENVOYER LE TEST</button>
        </div>
        <div class="right-panel"><div id="map"></div></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://update-github-csv-149052175314.europe-west1.run.app/";
        let map, markers, routeLayer, stops = [], mode = 'stop', pData = { lat:null, lon:null, addr:"" }, sTemp = { lat:null, lon:null };

        window.onload = function() {
            map = L.map('map').setView([46.6, 1.88], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers = L.layerGroup().addTo(map); routeLayer = L.layerGroup().addTo(map);
            map.on('click', onMapClick);
            Sortable.create(document.getElementById('stops-list'), { animation: 150, onEnd: reorderStops });
            loadSaved(); setMode('stop');
        };

        function resetAll() { localStorage.clear(); location.reload(); }
        function setMode(m) { mode = m; document.getElementById('btn-t-prod').style.background = m==='prod'?'var(--accent)':'#95a5a6'; document.getElementById('btn-t-stop').style.background = m==='stop'?'var(--accent)':'#95a5a6'; }

        function onMapClick(e) {
            let lat = e.latlng.lat, lon = e.latlng.lng;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`).then(r=>r.json()).then(d=>{
                if(mode==='prod'){ pData={lat, lon, addr:d.display_name}; document.getElementById('pAddr').value=d.display_name; saveProd(); }
                else { sTemp={lat, lon}; document.getElementById('sAddr').value=d.display_name; }
                updateMarkers();
            });
        }

        function searchAddress(target) {
            let q = document.getElementById(target==='prod'?'pAddr':'sAddr').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`).then(r=>r.json()).then(res=>{
                if(res.length>0){
                    let lat=parseFloat(res[0].lat), lon=parseFloat(res[0].lon);
                    map.setView([lat, lon], 14);
                    if(target==='prod'){ pData={lat, lon, addr:res[0].display_name}; document.getElementById('pAddr').value=res[0].display_name; saveProd(); }
                    else { sTemp={lat, lon}; document.getElementById('sAddr').value=res[0].display_name; }
                    updateMarkers();
                }
            });
        }

        function saveProd() { localStorage.setItem('pMem_v33', JSON.stringify(pData)); updateView(); }
        function loadSaved() { let s=localStorage.getItem('pMem_v33'); if(s){ pData=JSON.parse(s); document.getElementById('pAddr').value=pData.addr; updateView(); } }

        function addStop() {
            if(!pData.lat || !sTemp.lat) return alert("Pr√©cisez les adresses !");
            stops.push({ client: document.getElementById('sClient').value || "Client", lat: sTemp.lat, lon: sTemp.lon, addr: document.getElementById('sAddr').value, id: Date.now() });
            sTemp = { lat:null, lon:null }; document.getElementById('sAddr').value = ""; document.getElementById('sClient').value = "";
            updateView();
        }

        function reorderStops() { let ns=[]; document.querySelectorAll('.stop-item').forEach(it=>{ ns.push(stops.find(s=>s.id===parseInt(it.getAttribute('data-id')))); }); stops=ns; updateView(); }

        function updateView() {
            updateMarkers(); const ul=document.getElementById('stops-list'); ul.innerHTML="";
            stops.forEach((s, i) => { ul.innerHTML += `<li class="stop-item" data-id="${s.id}"><b>${i+1}. ${s.client}</b><button onclick="stops.splice(${i},1);updateView()">‚úï</button></li>`; });
            document.getElementById('btnSend').disabled = (stops.length === 0);
        }

        function updateMarkers() {
            markers.clearLayers();
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'üè†'})}).addTo(markers);
            stops.forEach(s => L.circleMarker([s.lat, s.lon], {radius:6, color:'blue'}).addTo(markers));
            if(sTemp.lat) L.circleMarker([sTemp.lat, sTemp.lon], {radius:8, color:'orange'}).addTo(markers);
        }

        function sendData() {
            const btn = document.getElementById('btnSend'); btn.disabled = true; btn.innerText = "‚è≥ Envoi...";
            const dateStr = new Date().toISOString().split('T')[0];
            const tourId = (document.getElementById('pName').value || "TEST").replace(/\s/g,'') + "_" + Date.now();
            
            // On pr√©pare les lignes avec r√©p√©tition des infos de t√™te
            const rows = [];
            // Ligne D√©p√¥t
            rows.push(formatRow(0, "D√©part D√©p√¥t", pData.addr, pData.lat, pData.lon, tourId, dateStr));
            // Lignes Clients
            stops.forEach((s, i) => { rows.push(formatRow(i+1, s.client, s.addr, s.lat, s.lon, tourId, dateStr)); });
            // Ligne Retour
            rows.push(formatRow(stops.length+1, "Retour D√©p√¥t", pData.addr, pData.lat, pData.lon, tourId, dateStr));

            fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rows: rows }) })
            .then(r => { if(r.ok) { alert("‚úÖ Test r√©ussi ! V√©rifiez le CSV."); stops=[]; updateView(); } })
            .finally(() => { btn.disabled = false; btn.innerText = "üöÄ ENVOYER LE TEST"; });
        }

        function formatRow(ordre, client, addr, lat, lon, tourId, date) {
            return {
                "Producteur": document.getElementById('pName').value,
                "Date de Livraison": date,
                "Jour": document.getElementById('pDay').value,
                "Tourn√©e ID": tourId,
                "Ordre d'Arr√™t": ordre,
                "Client / Point de Livraison": client,
                "Adresse Compl√®te": addr,
                "lat": lat, "lon": lon,
                "V√©hicule": document.getElementById('vType').value,
                "Cout Horaire (‚Ç¨/h)": parseFloat(document.getElementById('cH').value),
                "Cout Km (‚Ç¨/km)": parseFloat(document.getElementById('cK').value),
                "Temps Pr√©paration (min)": parseFloat(document.getElementById('tPrep').value)
            };
        }
    </script>
</body>
</html>
