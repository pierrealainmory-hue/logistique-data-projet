<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistique V26 - PrÃ©cision Temps DÃ©pÃ´t</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --bg: #f4f7f9; --danger: #e74c3c; --info: #3498db; --text: #546e7a; }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; }
        
        .header-band { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid var(--primary); }
        .header-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .header-row:last-child { margin-bottom: 0; }
        
        .main-container { display: flex; gap: 25px; }
        .left-panel { flex: 1; min-width: 420px; }
        .right-panel { flex: 2; }

        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eef2f7; }
        .form-group { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 120px; }
        .form-group label { font-weight: 600; color: var(--text); font-size: 0.8rem; }
        input, select { padding: 10px; border: 1px solid #dcdfe6; border-radius: 8px; font-size: 0.9rem; }
        
        /* KPI CARDS */
        .kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; border: 1px solid #e4e7ed; text-align: center; }
        .kpi-title { font-size: 0.7rem; font-weight: 700; color: var(--text); text-transform: uppercase; margin-bottom: 8px; }
        .kpi-value { font-size: 1.3rem; font-weight: 800; color: var(--primary); }
        
        .summary-banner { grid-column: span 3; background: var(--primary); color: white; border-radius: 10px; padding: 20px; display: flex; justify-content: space-around; align-items: center; }
        .summary-value { font-size: 1.8rem; font-weight: 800; display: block; }

        #map { height: 450px; width: 100%; border-radius: 12px; border: 1px solid #dcdfe6; }
        .stop-item { background: #fdfdfd; padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #ebedf0; }
        .stop-info { display: flex; align-items: center; gap: 10px; }
        .handle { cursor: grab; color: #b0bec5; font-size: 1.2rem; }

        .btn-main { background: var(--success); color: white; width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-mini { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸšš Simulation de TournÃ©e : <span style="color:var(--info)" id="display-depot">Point de DÃ©part</span></h2>
        <button onclick="resetAll()" class="btn-mini" style="background:var(--danger); color:white;">RÃ©initialiser l'outil</button>
    </div>

    <div class="header-band">
        <div class="header-row">
            <div class="form-group" style="flex: 1.5;">
                <label>Nom du DÃ©pÃ´t / Producteur</label>
                <input type="text" id="pName" placeholder="Ex: Ferme du Val" onchange="updateTitle()">
            </div>
            <div class="form-group">
                <label>JournÃ©e</label>
                <select id="pDay" onchange="saveProd()">
                    <option>Lundi</option><option>Mardi</option><option>Mercredi</option>
                    <option>Jeudi</option><option>Vendredi</option><option>Samedi</option>
                </select>
            </div>
            <div class="form-group" style="flex: 2;">
                <label>ğŸ“ Adresse du DÃ©pÃ´t (DÃ©part & Retour)</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="pAddr" placeholder="Rechercher..." style="flex:1;">
                    <button class="btn-mini" style="background:var(--info); color:white" onclick="searchAddress('prod')">ğŸ”</button>
                    <button class="btn-mini" id="btn-t-prod" style="background:#95a5a6; color:white" onclick="setMode('prod')">ğŸ¯</button>
                </div>
            </div>
        </div>
        <div class="header-row">
            <div class="form-group" style="flex: 1.5;">
                <label>ğŸšš VÃ©hicule</label>
                <select id="vType" onchange="saveProd()">
                    <option value="0.5">ğŸš² Petit utilitaire (< 3mÂ³)</option>
                    <option value="0.7" selected>ğŸš— Fourgon compact (3-6mÂ³)</option>
                    <option value="0.9">ğŸš Grand fourgon (6-12mÂ³)</option>
                    <option value="1.2">ğŸšš Petit camion (12-20mÂ³)</option>
                    <option value="1.6">ğŸš› Camion lourd (> 20mÂ³)</option>
                </select>
            </div>
            <div class="form-group"><label>ğŸ“¦ PrÃ©p. (min)</label><input type="number" id="tPrep" value="30" onchange="updateView()"></div>
            <div class="form-group"><label>ğŸšš Charg. (min)</label><input type="number" id="tLoad" value="20" onchange="updateView()"></div>
            <div class="form-group"><label>ğŸ’¶ Livreure (â‚¬/h)</label><input type="number" id="cH" value="18" onchange="updateView()"></div>
            <div class="form-group"><label>â›½ Carburant (â‚¬/km)</label><input type="number" id="cK" value="0.6" step="0.05" onchange="updateView()"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="card" style="border-left: 5px solid var(--success);">
                <h3 style="margin-top:0; font-size:1.1rem;">ğŸ“ Nouvel ArrÃªt</h3>
                <div class="form-group">
                    <label>Localisation</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="sAddr" placeholder="Adresse..." style="flex:1;">
                        <button class="btn-mini" style="background:var(--info); color:white" onclick="searchAddress('stop')">ğŸ”</button>
                        <button class="btn-mini" id="btn-t-stop" style="background:#95a5a6; color:white" onclick="setMode('stop')">ğŸ¯</button>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <div class="form-group">
                        <label>Type d'opÃ©ration</label>
                        <select id="sOpType">
                            <option value="ğŸ“¦">ğŸ“¦ Livraison Client</option>
                            <option value="ğŸšœ">ğŸšœ Collecte autrui</option>
                            <option value="ğŸ¬">ğŸ¬ Point Relais</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Nom / Lieu</label><input type="text" id="sClient"></div>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div class="form-group"><label>Valeur (â‚¬)</label><input type="number" id="sEuro" value="0"></div>
                    <div class="form-group"><label>ArrÃªt (min)</label><input type="number" id="sTime" value="15"></div>
                </div>
                <button class="btn-main" style="background:var(--info); margin-top:20px;" onclick="addStop()">Ajouter Ã  la tournÃ©e</button>
            </div>
            <h4 style="color:var(--text); margin-bottom:10px;">ğŸ“‹ ItinÃ©raire (Ordre modifiable)</h4>
            <ul id="stops-list"></ul>
            <button class="btn-main" id="btnSend" onclick="sendData()" disabled>ğŸš€ Enregistrer la TournÃ©e</button>
        </div>

        <div class="right-panel">
            <div id="map"></div>
            <div class="kpi-container">
                <div class="summary-banner">
                    <div style="text-align:center;"><span style="font-size:0.8rem; opacity:0.8;">COÃ›T GLOBAL</span><span class="summary-value" id="rTotal">0 â‚¬</span></div>
                    <div style="text-align:center;"><span style="font-size:0.8rem; opacity:0.8;">CHIFFRE D'AFFAIRES</span><span class="summary-value" id="rVal">0 â‚¬</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Route</div>
                    <div class="kpi-value" id="rDist">0 km</div>
                    <div style="font-size:0.7rem; color:var(--text);" id="rTime">0h00</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Frais de Route</div>
                    <div class="kpi-value" id="rCostTrans">0 â‚¬</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Frais de Personnel</div>
                    <div class="kpi-value" id="rCostOps">0 â‚¬</div>
                    <div style="font-size:0.7rem; color:var(--text);" id="rOps">0h00</div>
                </div>
                <div class="kpi-card" style="grid-column: span 3; border-top: 3px solid var(--accent);">
                    <div class="kpi-title">RATIO LOGISTIQUE (RentabilitÃ©)</div>
                    <div class="kpi-value" style="color:var(--accent); font-size:1.8rem;" id="rRatio">0 %</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const API = "https://update-github-csv-149052175314.europe-west1.run.app/";
        let map, markers, routeLayer;
        let stops = [];
        let mode = 'stop';
        let pData = { lat:null, lon:null, addr:"" };
        let sTemp = { lat:null, lon:null };

        window.onload = function() {
            map = L.map('map').setView([46.6, 1.88], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers = L.layerGroup().addTo(map);
            routeLayer = L.layerGroup().addTo(map);
            map.on('click', onMapClick);
            Sortable.create(document.getElementById('stops-list'), { animation: 150, handle: '.handle', onEnd: function() { reorderStops(); } });
            loadSaved();
            setMode('stop');
        };

        function updateTitle() { document.getElementById('display-depot').innerText = document.getElementById('pName').value || "Point de DÃ©part"; saveProd(); }
        function resetAll() { if(confirm("Tout effacer ?")) { localStorage.clear(); location.reload(); } }
        function setMode(m) { mode = m; document.getElementById('btn-t-prod').style.background = m==='prod' ? 'var(--accent)' : '#95a5a6'; document.getElementById('btn-t-stop').style.background = m==='stop' ? 'var(--accent)' : '#95a5a6'; }

        function onMapClick(e) {
            let lat = e.latlng.lat, lon = e.latlng.lng;
            showTempMarker(lat, lon);
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json()).then(d => {
                    if(mode === 'prod') { pData = { lat, lon, addr: d.display_name }; document.getElementById('pAddr').value = d.display_name; saveProd(); }
                    else { sTemp = { lat, lon }; document.getElementById('sAddr').value = d.display_name; }
                });
        }

        function searchAddress(target) {
            let q = document.getElementById(target === 'prod' ? 'pAddr' : 'sAddr').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`)
                .then(r => r.json()).then(res => {
                    if(res.length > 0) {
                        let lat = parseFloat(res[0].lat), lon = parseFloat(res[0].lon);
                        showTempMarker(lat, lon); map.setView([lat, lon], 14);
                        if(target === 'prod') { pData = { lat, lon, addr: res[0].display_name }; document.getElementById('pAddr').value = res[0].display_name; saveProd(); }
                        else { sTemp = { lat, lon }; document.getElementById('sAddr').value = res[0].display_name; }
                    }
                });
        }

        function showTempMarker(lat, lon) {
            markers.clearLayers();
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'ğŸ ', className:''})}).addTo(markers);
            stops.forEach(s => L.circleMarker([s.lat, s.lon], {radius:7, color:'var(--info)', fillOpacity:1}).addTo(markers));
            L.circleMarker([lat, lon], {radius:10, color:'var(--accent)', weight:3, fillOpacity:0.5}).addTo(markers);
        }

        function saveProd() { pData.name = document.getElementById('pName').value; pData.day = document.getElementById('pDay').value; localStorage.setItem('pMem_v26', JSON.stringify(pData)); updateView(); }
        function loadSaved() { let saved = localStorage.getItem('pMem_v26'); if(saved) { pData = JSON.parse(saved); document.getElementById('pName').value = pData.name || ""; document.getElementById('pAddr').value = pData.addr || ""; if(pData.day) document.getElementById('pDay').value = pData.day; updateTitle(); } }

        function addStop() {
            if(!pData.lat || !sTemp.lat) return alert("Position manquante");
            stops.push({ client: document.getElementById('sClient').value || "Client", icon: document.getElementById('sOpType').value, euro: parseFloat(document.getElementById('sEuro').value) || 0, time: parseFloat(document.getElementById('sTime').value) || 15, lat: sTemp.lat, lon: sTemp.lon, id: Date.now() });
            sTemp = { lat:null, lon:null }; document.getElementById('sAddr').value = ""; document.getElementById('sClient').value = ""; updateView();
        }

        function reorderStops() {
            const newStops = [];
            document.querySelectorAll('.stop-item').forEach(item => { newStops.push(stops.find(s => s.id === parseInt(item.getAttribute('data-id')))); });
            stops = newStops; updateView();
        }

        function updateView() {
            markers.clearLayers(); routeLayer.clearLayers();
            const ul = document.getElementById('stops-list'); ul.innerHTML = "";
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'ğŸ ', className:''})}).addTo(markers);
            stops.forEach((s, i) => {
                ul.innerHTML += `<li class="stop-item" data-id="${s.id}"><div class="stop-info"><span class="handle">â˜°</span> <span>${s.icon} <b>${i+1}.</b> ${s.client}</span></div><button onclick="deleteStop(${s.id})" style="border:none; background:none; color:red; cursor:pointer;">âœ•</button></li>`;
                L.circleMarker([s.lat, s.lon], {radius:7, color:'var(--info)', fillOpacity:1}).addTo(markers);
            });
            if(pData.lat && stops.length > 0) calcRoute();
            else updateStats(0,0);
            document.getElementById('btnSend').disabled = (stops.length === 0);
        }

        function deleteStop(id) { stops = stops.filter(s => s.id !== id); updateView(); }

        function calcRoute() {
            let pts = [[pData.lon, pData.lat], ...stops.map(s => [s.lon, s.lat]), [pData.lon, pData.lat]];
            fetch(`https://router.project-osrm.org/route/v1/driving/${pts.map(p => p.join(',')).join(';')}?overview=full&geometries=geojson`)
                .then(r => r.json()).then(res => {
                    if(res.code === 'Ok') {
                        let rData = res.routes[0];
                        L.polyline(rData.geometry.coordinates.map(c => [c[1], c[0]]), {color:'var(--info)', weight:5}).addTo(routeLayer);
                        map.fitBounds(L.featureGroup(markers.getLayers()).getBounds().pad(0.2));
                        updateStats(rData.distance/1000, rData.duration/60);
                    }
                });
        }

        function updateStats(dist, driveTime) {
            const cH = parseFloat(document.getElementById('cH').value) || 0, cK = parseFloat(document.getElementById('cK').value) || 0;
            const prep = parseFloat(document.getElementById('tPrep').value) || 0;
            const load = parseFloat(document.getElementById('tLoad').value) || 0;
            const sTime = stops.reduce((a, b) => a + b.time, 0) + prep + load;
            const cTrans = (dist * cK) + ((driveTime / 60) * cH), cOps = (sTime / 60) * cH, total = cTrans + cOps, val = stops.reduce((a, b) => a + b.euro, 0);
            document.getElementById('rDist').innerText = dist.toFixed(1) + " km";
            document.getElementById('rTime').innerText = Math.floor(driveTime/60) + "h" + Math.round(driveTime%60);
            document.getElementById('rOps').innerText = Math.floor(sTime/60) + "h" + Math.round(sTime%60);
            document.getElementById('rCostTrans').innerText = cTrans.toFixed(2) + " â‚¬";
            document.getElementById('rCostOps').innerText = cOps.toFixed(2) + " â‚¬";
            document.getElementById('rTotal').innerText = total.toFixed(2) + " â‚¬";
            document.getElementById('rVal').innerText = val.toFixed(2) + " â‚¬";
            document.getElementById('rRatio').innerText = val > 0 ? (total/val*100).toFixed(1) + " %" : "0 %";
        }

        function sendData() {
            const btn = document.getElementById('btnSend');
            btn.disabled = true;
            btn.innerText = "â³ Envoi en cours...";

            // On rÃ©cupÃ¨re les valeurs numÃ©riques propres (sans le symbole â‚¬)
            const payload = {
                general: {
                    Depot: document.getElementById('pName').value,
                    Jour: document.getElementById('pDay').value,
                    Vehicule: document.getElementById('vType').options[document.getElementById('vType').selectedIndex].text,
                    Distance_Km: parseFloat(document.getElementById('rDist').innerText),
                    Temps_Conduite: document.getElementById('rTime').innerText,
                    Temps_Service: document.getElementById('rOps').innerText,
                    Frais_Route_Eur: parseFloat(document.getElementById('rCostTrans').innerText),
                    Frais_Personnel_Eur: parseFloat(document.getElementById('rCostOps').innerText),
                    Cout_Global_Eur: parseFloat(document.getElementById('rTotal').innerText),
                    Valeur_Marchandise_Eur: parseFloat(document.getElementById('rVal').innerText),
                    Ratio_Logistique_Pct: parseFloat(document.getElementById('rRatio').innerText),
                    Temps_Preparation: parseFloat(document.getElementById('tPrep').value),
                    Temps_Chargement: parseFloat(document.getElementById('tLoad').value)
                },
                stops: stops.map((s, index) => ({
                    ordre: index + 1,
                    type: s.icon,
                    client: s.client,
                    valeur_eur: s.euro,
                    temps_sur_place_min: s.time,
                    latitude: s.lat,
                    longitude: s.lon
                }))
            };

            fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) throw new Error("Erreur rÃ©seau");
                return response.json();
            })
            .then(data => {
                alert("âœ… TournÃ©e enregistrÃ©e avec succÃ¨s !");
                stops = [];
                updateView();
            })
            .catch(error => {
                alert("âŒ Erreur lors de l'envoi. VÃ©rifiez votre connexion.");
                console.error(error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "ğŸš€ Enregistrer la TournÃ©e";
            });
        }
    </script>
</body>
</html>
