<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistique V23 - Clart√© & Pr√©cision</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --bg: #f4f7f6; --danger: #e74c3c; --info: #2980b9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; }
        
        /* BANDEAU POINT DE D√âPART */
        .header-band { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border-top: 8px solid var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .header-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-locked { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-empty { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .main-container { display: flex; gap: 30px; flex-wrap: wrap; }
        .left-panel { flex: 1; min-width: 450px; }
        .right-panel { flex: 1.5; min-width: 450px; }

        .card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .active-zone { border: 2px solid var(--accent) !important; background: #fffdf9 !important; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-weight: 600; color: #546e7a; margin-bottom: 8px; font-size: 0.85rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 0.9rem; }
        
        /* RESULTATS STYLE */
        .result-card { background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #e0e6ed; }
        .result-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e0e6ed; font-weight: bold; color: #2c3e50; }
        .result-row { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #f0f2f5; font-size: 1.05rem; }
        .result-row:last-child { border-bottom: none; }
        .result-label { color: #607d8b; }
        .result-value { font-weight: 700; color: var(--primary); }
        .total-box { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .total-box .result-value { color: #fff; font-size: 1.8rem; }
        
        /* MAP & LIST */
        #map { height: 500px; width: 100%; border-radius: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        .stop-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; border-left: 6px solid var(--info); box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .handle { cursor: grab; color: #b0bec5; margin-right: 15px; font-size: 20px; }
        
        .btn-main { background: var(--success); color: white; width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-main:disabled { background: #cfd8dc; }
        .btn-mini { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">üì¶ Gestion de Tourn√©e : <span style="color:var(--info)">D√©part & Retour D√©p√¥t</span></h2>
        <button onclick="resetAll()" class="btn-mini" style="background:var(--danger); color:white;">üßπ R√©initialiser l'outil</button>
    </div>

    <div class="header-band" id="box-prod" onclick="setMode('prod')">
        <div class="header-title">
            <span style="font-weight: bold; color: var(--primary); font-size: 1.1rem;">üè† Configuration du D√©p√¥t (D√©part & Arriv√©e)</span>
            <span id="lock-status" class="status-badge status-empty">D√©p√¥t non d√©fini</span>
        </div>
        <div class="grid">
            <div class="form-group">
                <label>Nom du D√©p√¥t / Ferme</label>
                <input type="text" id="pName" placeholder="Ex: Entrep√¥t Principal" onchange="saveProd()">
            </div>
            <div class="form-group">
                <label>üìÖ Journ√©e de livraison</label>
                <select id="pDay" onchange="saveProd()">
                    <option>Lundi</option><option>Mardi</option><option>Mercredi</option>
                    <option>Jeudi</option><option>Vendredi</option><option>Samedi</option>
                </select>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>üìç Adresse du D√©p√¥t</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="pAddr" placeholder="Chercher une adresse...">
                    <button class="btn-mini" style="background:var(--info); color:white" onclick="searchAddress('prod')">üîç</button>
                    <button class="btn-mini" id="btn-t-prod" style="background:#95a5a6; color:white" onclick="setMode('prod'); event.stopPropagation();">üéØ</button>
                </div>
            </div>
            <div class="form-group">
                <label>üöö Type de V√©hicule</label>
                <select id="vType">
                    <option value="0.4">üö≤ V√©lo Cargo</option>
                    <option value="0.6">üöó Utilitaire l√©ger</option>
                    <option value="0.9" selected>üöê Fourgon (Type Master)</option>
                    <option value="1.5">üöö Camion Porteur</option>
                </select>
            </div>
            <div class="form-group"><label>üí∂ Co√ªt Horaire Chauffeur (‚Ç¨/h)</label><input type="number" id="cH" value="18"></div>
            <div class="form-group"><label>‚õΩ Co√ªt Kilom√©trique (‚Ç¨/km)</label><input type="number" id="cK" value="0.60" step="0.05"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="card" id="box-stop" onclick="setMode('stop')" style="border-left: 8px solid var(--success);">
                <h3 style="margin-top:0;">üìç Ajouter un point de livraison</h3>
                <div class="form-group">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="sAddr" placeholder="Adresse du client...">
                        <button class="btn-mini" style="background:var(--info); color:white" onclick="searchAddress('stop')">üîç</button>
                        <button class="btn-mini" id="btn-t-stop" style="background:#95a5a6; color:white" onclick="setMode('stop'); event.stopPropagation();">üéØ</button>
                    </div>
                </div>
                <div class="grid" style="margin-top:15px;">
                    <div class="form-group" style="grid-column: span 2;"><label>Nom du destinataire</label><input type="text" id="sClient"></div>
                    <div class="form-group"><label>Valeur Marchandise (‚Ç¨)</label><input type="number" id="sEuro" value="0"></div>
                    <div class="form-group"><label>Temps sur place (min)</label><input type="number" id="sTime" value="15"></div>
                </div>
                <button class="btn-main" style="background:var(--info); margin-top:20px;" onclick="addStop()">Ajouter √† la tourn√©e</button>
            </div>

            <h4 style="color:#546e7a;">üìã Itin√©raire de livraison (ordonnable)</h4>
            <ul id="stops-list"></ul>
            
            <button class="btn-main" id="btnSend" onclick="sendData()" disabled>üöÄ Valider et Enregistrer la Tourn√©e</button>
        </div>

        <div class="right-panel">
            <div id="map"></div>
            
            <div class="grid" style="margin-top:25px;">
                <div class="result-card">
                    <div class="result-header">üìà Analyse de la Route</div>
                    <div class="result-row"><span class="result-label">Distance totale :</span> <span class="result-value" id="rDist">0 km</span></div>
                    <div class="result-row"><span class="result-label">Temps de conduite :</span> <span class="result-value" id="rTime">0h00</span></div>
                    <div class="result-row"><span class="result-label">Temps de service :</span> <span class="result-value" id="rOps">0h00</span></div>
                </div>
                
                <div class="result-card">
                    <div class="result-header">üí∂ D√©tails des Co√ªts</div>
                    <div class="result-row"><span class="result-label">Frais de route :</span> <span class="result-value" id="rCostTrans">0 ‚Ç¨</span></div>
                    <div class="result-row"><span class="result-label">Frais de personnel :</span> <span class="result-value" id="rCostOps">0 ‚Ç¨</span></div>
                    <div class="result-row"><span class="result-label">Marchandise embarqu√©e :</span> <span class="result-value" id="rVal">0 ‚Ç¨</span></div>
                </div>

                <div class="result-card" style="grid-column: span 2;">
                    <div class="total-box">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px;">CO√õT TOTAL LOGISTIQUE</div>
                        <div class="result-value" id="rTotal">0 ‚Ç¨</div>
                        <div style="margin-top:10px; font-weight:bold;">Ratio Logistique : <span id="rRatio">0%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://update-github-csv-149052175314.europe-west1.run.app/";
        let map, markers, routeLayer;
        let stops = [];
        let mode = 'stop';
        let pData = { lat:null, lon:null, addr:"" };
        let sTemp = { lat:null, lon:null };

        window.onload = function() {
            map = L.map('map').setView([46.6, 1.88], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markers = L.layerGroup().addTo(map);
            routeLayer = L.layerGroup().addTo(map);
            map.on('click', onMapClick);
            
            Sortable.create(document.getElementById('stops-list'), {
                animation: 150, handle: '.handle', onEnd: function() { reorderStops(); }
            });

            loadSaved();
            setMode('stop');
        };

        function resetAll() {
            localStorage.clear();
            pData = { lat:null, lon:null, addr:"" };
            stops = [];
            document.getElementById('pName').value = "";
            document.getElementById('pAddr').value = "";
            updateView();
            checkLock();
            location.reload();
        }

        function checkLock() {
            const badge = document.getElementById('lock-status');
            if(pData.lat) {
                badge.innerText = "Point de d√©part verrouill√© ‚úì";
                badge.className = "status-badge status-locked";
            } else {
                badge.innerText = "D√©p√¥t non d√©fini";
                badge.className = "status-badge status-empty";
            }
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btn-t-prod').style.background = m==='prod' ? 'var(--accent)' : '#95a5a6';
            document.getElementById('btn-t-stop').style.background = m==='stop' ? 'var(--accent)' : '#95a5a6';
            document.getElementById('box-prod').classList.toggle('active-zone', m==='prod');
            document.getElementById('box-stop').classList.toggle('active-zone', m==='stop');
        }

        function onMapClick(e) {
            let lat = e.latlng.lat, lon = e.latlng.lng;
            showTempMarker(lat, lon);
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json()).then(d => {
                    let a = d.display_name || "Lieu choisi";
                    if(mode === 'prod') {
                        pData = { lat, lon, addr: a, name: document.getElementById('pName').value, day: document.getElementById('pDay').value };
                        document.getElementById('pAddr').value = a;
                        saveProd();
                    } else {
                        sTemp = { lat, lon };
                        document.getElementById('sAddr').value = a;
                    }
                });
        }

        function searchAddress(target) {
            let q = document.getElementById(target === 'prod' ? 'pAddr' : 'sAddr').value;
            if(q.length < 3) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`)
                .then(r => r.json()).then(res => {
                    if(res.length > 0) {
                        let lat = parseFloat(res[0].lat), lon = parseFloat(res[0].lon);
                        showTempMarker(lat, lon);
                        map.setView([lat, lon], 14);
                        if(target === 'prod') {
                            pData = { lat, lon, addr: res[0].display_name, name: document.getElementById('pName').value, day: document.getElementById('pDay').value };
                            document.getElementById('pAddr').value = res[0].display_name;
                            saveProd();
                        } else {
                            sTemp = { lat, lon };
                            document.getElementById('sAddr').value = res[0].display_name;
                        }
                    }
                });
        }

        function showTempMarker(lat, lon) {
            markers.clearLayers();
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'üè†', className:''})}).addTo(markers);
            stops.forEach(s => L.circleMarker([s.lat, s.lon], {radius:7, color:'var(--info)', fillOpacity:1}).addTo(markers));
            L.circleMarker([lat, lon], {radius:10, color:'var(--accent)', weight:3, fillOpacity:0.5}).addTo(markers);
        }

        function saveProd() {
            pData.name = document.getElementById('pName').value;
            pData.day = document.getElementById('pDay').value;
            localStorage.setItem('pMem_v23', JSON.stringify(pData));
            checkLock();
            updateView();
        }

        function loadSaved() {
            let saved = localStorage.getItem('pMem_v23');
            if(saved) {
                pData = JSON.parse(saved);
                document.getElementById('pName').value = pData.name || "";
                document.getElementById('pAddr').value = pData.addr || "";
                if(pData.day) document.getElementById('pDay').value = pData.day;
            }
            checkLock();
            updateView();
        }

        function addStop() {
            if(!pData.lat) return alert("Veuillez d'abord d√©finir le point de d√©part.");
            if(!sTemp.lat) return alert("Veuillez choisir une adresse sur la carte.");
            stops.push({
                client: document.getElementById('sClient').value || "Client",
                euro: parseFloat(document.getElementById('sEuro').value) || 0,
                time: parseFloat(document.getElementById('sTime').value) || 15,
                lat: sTemp.lat, lon: sTemp.lon, id: Date.now()
            });
            sTemp = { lat:null, lon:null };
            document.getElementById('sAddr').value = "";
            document.getElementById('sClient').value = "";
            updateView();
        }

        function reorderStops() {
            const newStops = [];
            document.querySelectorAll('.stop-item').forEach(item => {
                const id = parseInt(item.getAttribute('data-id'));
                newStops.push(stops.find(s => s.id === id));
            });
            stops = newStops;
            updateView();
        }

        function updateView() {
            markers.clearLayers();
            routeLayer.clearLayers();
            const ul = document.getElementById('stops-list');
            ul.innerHTML = "";
            
            if(pData.lat) L.marker([pData.lat, pData.lon], {icon: L.divIcon({html:'üè†', className:''})}).addTo(markers);
            
            stops.forEach((s, i) => {
                ul.innerHTML += `
                    <li class="stop-item" data-id="${s.id}">
                        <div><span class="handle">‚ò∞</span> <b>${i+1}.</b> ${s.client}</div>
                        <button onclick="deleteStop(${s.id})" style="border:none; background:none; cursor:pointer; color:red;">‚úï</button>
                    </li>`;
                L.circleMarker([s.lat, s.lon], {radius:7, color:'var(--info)', fillOpacity:1}).addTo(markers);
            });
            
            if(pData.lat && stops.length > 0) calcRoute();
            else updateStats(0,0);
            document.getElementById('btnSend').disabled = (stops.length === 0);
        }

        function deleteStop(id) {
            stops = stops.filter(s => s.id !== id);
            updateView();
        }

        function calcRoute() {
            let pts = [[pData.lon, pData.lat], ...stops.map(s => [s.lon, s.lat]), [pData.lon, pData.lat]];
            fetch(`https://router.project-osrm.org/route/v1/driving/${pts.map(p => p.join(',')).join(';')}?overview=full&geometries=geojson`)
                .then(r => r.json()).then(res => {
                    if(res.code === 'Ok') {
                        let rData = res.routes[0];
                        L.polyline(rData.geometry.coordinates.map(c => [c[1], c[0]]), {color:'var(--info)', weight:5}).addTo(routeLayer);
                        map.fitBounds(L.featureGroup(markers.getLayers()).getBounds().pad(0.2));
                        updateStats(rData.distance/1000, rData.duration/60);
                    }
                });
        }

        function updateStats(dist, driveTime) {
            const cH = parseFloat(document.getElementById('cH').value) || 0;
            const cK = parseFloat(document.getElementById('cK').value) || 0;
            const sTime = stops.reduce((a, b) => a + b.time, 0) + 50; // +50 min (pr√©paration/chargement fixe)
            
            const cTrans = (dist * cK) + ((driveTime / 60) * cH);
            const cOps = (sTime / 60) * cH;
            const total = cTrans + cOps;
            const val = stops.reduce((a, b) => a + b.euro, 0);

            document.getElementById('rDist').innerText = dist.toFixed(1) + " km";
            document.getElementById('rTime').innerText = Math.floor(driveTime/60) + "h " + Math.round(driveTime%60) + "m";
            document.getElementById('rOps').innerText = Math.floor(sTime/60) + "h " + Math.round(sTime%60) + "m";
            document.getElementById('rCostTrans').innerText = cTrans.toFixed(2) + " ‚Ç¨";
            document.getElementById('rCostOps').innerText = cOps.toFixed(2) + " ‚Ç¨";
            document.getElementById('rTotal').innerText = total.toFixed(2) + " ‚Ç¨";
            document.getElementById('rVal').innerText = val.toFixed(2) + " ‚Ç¨";
            document.getElementById('rRatio').innerText = val > 0 ? (total/val*100).toFixed(1) + "%" : "0%";
        }

        function sendData() {
            const btn = document.getElementById('btnSend');
            btn.disabled = true; btn.innerText = "Enregistrement en cours...";
            const payload = {
                general: { 
                    Depot: document.getElementById('pName').value, 
                    Jour: document.getElementById('pDay').value,
                    CoutTotal: document.getElementById('rTotal').innerText,
                    Distance: document.getElementById('rDist').innerText
                },
                stops: stops
            };
            fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(() => { alert("‚úÖ Tourn√©e sauvegard√©e !"); stops = []; updateView(); })
            .catch(() => alert("‚ùå Erreur serveur"))
            .finally(() => { btn.disabled = false; btn.innerText = "üöÄ Valider et Enregistrer la Tourn√©e"; });
        }
    </script>
</body>
</html>
