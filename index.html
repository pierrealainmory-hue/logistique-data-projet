<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saisie de Tourn√©e Compl√®te</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f4f7f6; color: #333; }
        .header-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .left-panel { flex: 1; min-width: 350px; }
        .right-panel { flex: 1.5; min-width: 350px; }
        
        /* Inputs */
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        label { font-weight: 600; color: #2c3e50; font-size: 0.9em; display: block; margin-top: 5px; }
        .row-inputs { display: flex; gap: 15px; }
        .row-inputs > div { flex: 1; }

        /* Zone d'ajout d'arr√™t */
        .add-stop-box { background: white; padding: 25px; border-radius: 8px; border-top: 5px solid #1abc9c; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .add-stop-box h3 { margin-top: 0; color: #16a085; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Recherche Adresse */
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-start; }
        .search-box input { margin-bottom: 0; }
        .btn-search { background: #8e44ad; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-weight: bold; }
        .btn-search:hover { background: #732d91; }

        /* Liste des arr√™ts */
        #stops-list { list-style: none; padding: 0; }
        .stop-item { background: white; padding: 15px; margin-bottom: 10px; border-left: 5px solid #3498db; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 4px; }
        .stop-number { background: #3498db; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-weight: bold; margin-right: 15px; display: inline-block; flex-shrink: 0; }
        
        /* Carte */
        #map { height: 650px; width: 100%; border-radius: 8px; border: 1px solid #ccc; z-index: 1; }
        
        /* Boutons */
        .btn-add { background: #2980b9; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1.1em; transition: background 0.3s; }
        .btn-add:hover { background: #2471a3; }
        
        .btn-save { background: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; transition: background 0.3s; }
        .btn-save:hover { background: #219150; }
        .btn-save:disabled { background: #95a5a6; cursor: not-allowed; }
        
        .helper-text { font-size: 0.85em; color: #e74c3c; font-weight: bold; display: none; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header-box">
        <h1 style="margin-top:0;">üöö Cr√©ation de Tourn√©e</h1>
        <div class="row-inputs">
            <div>
                <label>Nom du Producteur</label>
                <input type="text" id="prodName" placeholder="Votre nom">
            </div>
            <div>
                <label>Jour de Tourn√©e</label>
                <select id="prodDay">
                    <option value="Lundi">Lundi</option>
                    <option value="Mardi">Mardi</option>
                    <option value="Mercredi">Mercredi</option>
                    <option value="Jeudi">Jeudi</option>
                    <option value="Vendredi">Vendredi</option>
                </select>
            </div>
            <div>
                <label>Temps Chargement D√©part (min)</label>
                <input type="number" id="loadTime" placeholder="Ex: 30" min="0">
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            
            <div class="add-stop-box">
                <h3>‚ûï Ajouter un arr√™t</h3>
                
                <label>üìç Localiser (Recherche adresse ou clic sur carte)</label>
                <div class="search-box">
                    <input type="text" id="addressSearch" placeholder="Ex: 10 rue de la R√©publique, Lyon" onkeypress="handleEnter(event)">
                    <button class="btn-search" type="button" onclick="searchAddress()">üîç Chercher</button>
                </div>
                <div id="latlon-preview" style="color: #16a085; font-size: 0.9em; margin-bottom: 15px; font-weight: bold; text-align: right;">Coordonn√©es : En attente...</div>

                <label>Nom Client / Lieu</label>
                <input type="text" id="stopClient" placeholder="Ex: Restaurant Le Gourmet">
                
                <div class="row-inputs">
                    <div>
                        <label>Poids (kg)</label>
                        <input type="number" id="stopWeight" placeholder="0">
                    </div>
                    <div>
                        <label>Montant (‚Ç¨)</label>
                        <input type="number" id="stopEuro" placeholder="0">
                    </div>
                </div>

                <div>
                    <label>Temps d'arr√™t estim√© (min)</label>
                    <input type="number" id="stopTime" placeholder="15">
                </div>
                
                
                <button class="btn-add" type="button" onclick="addStop()">Valider cet arr√™t</button>
                <p id="error-msg" class="helper-text">‚ö†Ô∏è Erreur : Veuillez remplir le nom du client, le poids, et localiser le point sur la carte.</p>
            </div>

            <h3 style="margin-left: 5px;">üìã R√©capitulatif (<span id="count">0</span> arr√™ts)</h3>
            <ul id="stops-list"></ul>

            <button class="btn-save" id="finalBtn" onclick="sendTournee()" disabled>üöÄ ENVOYER LA TOURN√âE</button>
            <div id="status-msg" style="text-align: center; margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px;"></div>
        </div>

        <div class="right-panel">
            <div id="map"></div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://update-github-csv-149052175314.europe-west1.run.app/"; 

    let tourneeStops = [];
    let tempMarker = null;
    let mapMarkers = [];
    let polyline = null;
    let currentAddressTxt = "Saisie Carte";

    // Initialisation de la carte (Doit se faire apr√®s le chargement des scripts Leaflet)
    var map = L.map('map').setView([46.603354, 1.888334], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

    // Fonction pour g√©rer la touche "Entr√©e" dans la barre de recherche
    function handleEnter(e) {
        if (e.key === 'Enter') searchAddress();
    }

    // Fonction de recherche d'adresse
    function searchAddress() {
        let query = document.getElementById('addressSearch').value;
        if(query.length < 3) return;

        let btn = document.querySelector('.btn-search');
        btn.innerText = "‚è≥...";
        btn.disabled = true;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if(data && data.length > 0) {
                let lat = data[0].lat;
                let lon = data[0].lon;
                currentAddressTxt = query;
                
                updateTempMarker(lat, lon);
                map.setView([lat, lon], 16); 
            } else {
                alert("Adresse introuvable. Essayez avec le code postal.");
            }
        })
        .catch(err => alert("Erreur de connexion"))
        .finally(() => {
            btn.innerText = "üîç Chercher";
            btn.disabled = false;
        });
    }

    // Clic sur la carte
    map.on('click', function(e) {
        currentAddressTxt = "Point√© sur la carte";
        updateTempMarker(e.latlng.lat, e.latlng.lng);
    });

    function updateTempMarker(lat, lon) {
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker([lat, lon], {opacity: 0.7}).addTo(map);
        
        let el = document.getElementById('latlon-preview');
        el.dataset.lat = parseFloat(lat).toFixed(6);
        el.dataset.lon = parseFloat(lon).toFixed(6);
        el.innerText = `üìç Position valid√©e : ${parseFloat(lat).toFixed(4)}, ${parseFloat(lon).toFixed(4)}`;
        el.style.color = "#27ae60"; // Vert
        document.getElementById('error-msg').style.display = 'none';
    }

    function addStop() {
        let client = document.getElementById('stopClient').value;
        let poids = document.getElementById('stopWeight').value;
        let montant = document.getElementById('stopEuro').value;
        let tempsArret = document.getElementById('stopTime').value;
        
        let el = document.getElementById('latlon-preview');
        let lat = el.dataset.lat;
        let lon = el.dataset.lon;

        // Validation stricte
        if (!client || !poids || !lat) {
            document.getElementById('error-msg').style.display = 'block';
            return;
        }

        let stopData = { 
            client: client, 
            poids: poids, 
            montant: montant || 0,
            temps_arret: tempsArret || 0,
            adresse_txt: currentAddressTxt,
            lat: lat, 
            lon: lon 
        };
        tourneeStops.push(stopData);

        // Ajout Liste HTML
        let li = document.createElement('li');
        li.className = 'stop-item';
        li.innerHTML = `
            <div style="width:100%">
                <div style="font-weight:bold; font-size:1.1em; color:#2c3e50;">
                    <span class="stop-number">${tourneeStops.length}</span> ${client}
                </div>
                <div style="color:#7f8c8d; margin-top:5px; font-size:0.9em">
                    ‚öñÔ∏è ${poids}kg &nbsp;|&nbsp; üí∂ ${montant}‚Ç¨ &nbsp;|&nbsp; ‚è±Ô∏è ${tempsArret} min
                </div>
            </div>`;
        document.getElementById('stops-list').appendChild(li);

        // Marker sur carte
        if (tempMarker) map.removeLayer(tempMarker);
        let finalMarker = L.marker([lat, lon]).addTo(map)
            .bindPopup(`<b>${tourneeStops.length}. ${client}</b><br>${poids}kg`);
        mapMarkers.push(finalMarker);
        drawRoute();

        // Reset
        document.getElementById('stopClient').value = '';
        document.getElementById('stopWeight').value = '';
        document.getElementById('stopEuro').value = '';
        document.getElementById('stopTime').value = '';
        document.getElementById('addressSearch').value = '';
        el.innerText = "Coordonn√©es : En attente...";
        el.style.color = "#16a085";
        delete el.dataset.lat;
        
        document.getElementById('count').innerText = tourneeStops.length;
        document.getElementById('finalBtn').disabled = false;
        document.getElementById('finalBtn').innerText = `üöÄ ENVOYER (${tourneeStops.length} arr√™ts)`;
    }

    function drawRoute() {
        if (polyline) map.removeLayer(polyline);
        let latlngs = tourneeStops.map(s => [s.lat, s.lon]);
        polyline = L.polyline(latlngs, {color: '#3498db', weight: 4, dashArray: '10, 10'}).addTo(map);
        
        // Ajuster la vue pour voir tous les points
        if(latlngs.length > 0) {
            var group = new L.featureGroup(mapMarkers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    function sendTournee() {
        let producteur = document.getElementById('prodName').value;
        let jour = document.getElementById('prodDay').value;
        let loadTime = document.getElementById('loadTime').value;

        if (!producteur) { alert("‚ö†Ô∏è Merci de renseigner votre Nom de Producteur tout en haut !"); return; }

        let btn = document.getElementById('finalBtn');
        let status = document.getElementById('status-msg');
        
        btn.disabled = true;
        btn.innerText = "Envoi en cours...";
        status.innerText = "‚è≥ Envoi des donn√©es au serveur...";
        status.style.backgroundColor = "#d6eaf8";
        status.style.color = "#2980b9";

        let payload = {
            general: { 
                Producteur: producteur, 
                Jour: jour,
                TempsChargement: loadTime || 0 
            },
            stops: tourneeStops
        };

        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                status.innerText = "‚úÖ Succ√®s ! Tourn√©e enregistr√©e.";
                status.style.backgroundColor = "#d4edda";
                status.style.color = "#155724";
                setTimeout(() => location.reload(), 2000);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(err => {
            status.innerText = "‚ùå Erreur : " + err.message;
            status.style.backgroundColor = "#f8d7da";
            status.style.color = "#721c24";
            btn.disabled = false;
            btn.innerText = "R√©essayer";
        });
    }
</script>

</body>
</html>
